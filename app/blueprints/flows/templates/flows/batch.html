{% extends "base.html" %}
{% block content %}
<!-- <h1 class="h3 mb-3 fw-bold">排程管理</h1>
<p class="form-text">選擇要加入的流程，加入後可拖曳或用上/下移調整順序，設定完成後執行排程。</p> -->

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
  <div>
    <h1 class="h3 mb-0 fw-bold">定義流程</h1>
    <p class="form-text">選擇要加入的流程，加入後可拖曳或用上/下移調整順序，設定完成後執行排程。</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1" href="{{ url_for('flows_bp.flow_builder', task_id=task.id) }}">
      <i class="bi bi-arrow-left"></i>
      返回流程管理
    </a>
  </div>
</div>

<form id="batch_flow_form" action="{{ url_for('flows_bp.run_flow_batch', task_id=task.id) }}" method="post" class="card card-body">
  <input type="hidden" name="flow_sequence" id="flow_sequence" value="">
  <div class="row g-2 align-items-end">
    <div class="col-md-auto">
      <div class="dropdown batch-dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
          選擇流程
        </button>
        <div class="dropdown-menu p-3" style="min-width: 340px; max-width: 480px;">
          <div class="small text-muted mb-2">可勾選多個流程後加入清單</div>
          {% for f in flows %}
            <div class="form-check">
              <input class="form-check-input batch-flow-option" type="checkbox" value="{{ f.name }}" id="batchFlowOpt{{ loop.index }}">
              <label class="form-check-label" for="batchFlowOpt{{ loop.index }}" title="{{ f.name }}">{{ f.name }}</label>
            </div>
          {% else %}
            <div class="text-muted">尚無流程</div>
          {% endfor %}
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-sm btn-outline-secondary" type="button" id="batchFlowAddAllBtn">全部勾選</button>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="batchFlowClearAllBtn">取消勾選</button>
            <button class="btn btn-sm btn-primary" type="button" id="batchFlowAddSelectedBtn">加入已勾選</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-auto">
      <button class="btn btn-success" type="submit">執行排程</button>
    </div>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-sm align-middle text-center mb-2 batch-table">
      <thead>
        <tr>
          <th class="batch-col">排序</th>
          <th class="text-start">流程名稱</th>
          <th class="batch-col">操作</th>
        </tr>
      </thead>
      <tbody id="batchFlowList">
        <tr class="text-muted" data-empty="1"><td colspan="3">尚未加入流程</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 align-items-center"></div>
  {% if batch_id %}
  <div class="mt-3 small" id="batchStatusBox"
       data-status-url="{{ url_for('flows_bp.flow_batch_status', task_id=task.id, batch_id=batch_id) }}"
       data-result-url="{{ url_for('flows_bp.flow_batch_result', task_id=task.id, batch_id=batch_id) }}">
    <div class="text-muted">批次執行中...</div>
  </div>
  <div class="mt-2" id="batchResultLinkWrap" style="display:none;">
    <a class="btn btn-outline-primary" id="batchResultLink"
       href="{{ url_for('flows_bp.flow_batch_result', task_id=task.id, batch_id=batch_id) }}">查看執行結果</a>
  </div>
  {% endif %}
</form>

<!-- <div class="d-flex gap-2 mt-3">
  <a class="btn btn-outline-secondary" href="{{ url_for('flows_bp.flow_builder', task_id=task.id) }}">返回流程管理</a>
</div> -->

<style>
.batch-table {
  --bs-table-bg: transparent;
  --bs-table-striped-bg: transparent;
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
  width: 100%;
}
.batch-table th,
.batch-table td {
  width: 33.3333%;
}
.batch-table th.batch-col,
.batch-table td.batch-col {
  width: 33.3333%;
}
.batch-table thead th {
  font-size: 12px;
  font-weight: 600;
  color: #6b6a65;
  border-bottom: 1px solid #e9e9e7;
}
.batch-table tbody tr td {
  border-top: 1px solid #e9e9e7;
}
.batch-dropdown .dropdown-menu {
  white-space: nowrap;
  overflow-x: hidden;
}
.batch-dropdown .form-check {
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.batch-dropdown .form-check-label {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.batch-flow-handle {
  cursor: grab;
  font-size: 1.1rem;
  letter-spacing: 1px;
  color: #a7a6a2;
  transition: color 0.15s ease-in-out, opacity 0.15s ease-in-out;
  opacity: 0.6;
}
#batchFlowList tr[draggable="true"] {
  cursor: move;
}
.batch-row {
  background: #ffffff;
  transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
.batch-row:hover {
  background: #f7f7f5;
}
.batch-row:hover .batch-flow-handle {
  color: #4f4f4b;
  opacity: 1;
}
.batch-row.drag-over-top td {
  border-top: 4px solid #2f7cff;
  background: linear-gradient(to bottom, rgba(47, 124, 255, 0.16), rgba(47, 124, 255, 0.04));
}
.batch-row.drag-over-bottom td {
  border-bottom: 4px solid #2f7cff;
  background: linear-gradient(to top, rgba(47, 124, 255, 0.16), rgba(47, 124, 255, 0.04));
}
.batch-row.drag-over-top,
.batch-row.drag-over-bottom {
  box-shadow: inset 0 0 0 1px rgba(47, 124, 255, 0.2);
}
</style>

<script>
const BATCH_TASK_ID = "{{ task.id }}";
const batchForm = document.getElementById('batch_flow_form');
const flowSequenceInput = document.getElementById('flow_sequence');
const batchFlowAddSelectedBtn = document.getElementById('batchFlowAddSelectedBtn');
const batchFlowAddAllBtn = document.getElementById('batchFlowAddAllBtn');
const batchFlowClearAllBtn = document.getElementById('batchFlowClearAllBtn');
const batchFlowList = document.getElementById('batchFlowList');
const batchFlowOptions = () => Array.from(document.querySelectorAll('.batch-flow-option'));
const { escapeHtml } = window.UiUtils;
let batchSelected = [];
let draggingBatchRow = null;
let dragOverRow = null;
let dragOverPos = null;
const transparentDragImage = new Image();
transparentDragImage.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
const batchStorageKey = `batchFlowSelection:${BATCH_TASK_ID}`;
const dropdownWrap = document.querySelector('.batch-dropdown');
const dropdownMenu = dropdownWrap ? dropdownWrap.querySelector('.dropdown-menu') : null;
const dropdownToggleBtn = dropdownWrap ? dropdownWrap.querySelector('[data-bs-toggle="dropdown"]') : null;

function updateDropdownWidth(){
  if (!dropdownMenu) return;
  const labels = dropdownMenu.querySelectorAll('.form-check-label');
  if (!labels.length) return;
  dropdownMenu.style.width = "auto";
  dropdownMenu.style.maxWidth = "none";
  let maxWidth = 0;
  labels.forEach(label => {
    const width = label.scrollWidth || label.getBoundingClientRect().width;
    if (width > maxWidth) maxWidth = width;
  });
  const padding = 80; // checkbox + padding + scrollbar buffer
  const maxAllowed = Math.floor(window.innerWidth * 0.9);
  const width = Math.min(Math.max(maxWidth + padding, 320), Math.min(640, maxAllowed));
  dropdownMenu.style.width = `${width}px`;
  dropdownMenu.style.maxWidth = `${Math.min(640, maxAllowed)}px`;
  dropdownMenu.style.overflowX = "hidden";
}

function renderBatchList(){
  if (!batchFlowList) return;
  if (!batchSelected.length){
    batchFlowList.innerHTML = '<tr class="text-muted" data-empty="1"><td colspan="3">尚未加入流程</td></tr>';
    return;
  }
  const rows = batchSelected.map((name, idx) => {
    const safeName = escapeHtml(name);
    return `
      <tr data-flow="${safeName}" draggable="true" class="batch-row">
        <td>
          <div class="d-inline-flex align-items-center gap-2">
            <span class="batch-flow-handle" title="拖曳排序" aria-hidden="true">⋮⋮</span>
          </div>
        </td>
        <td class="text-start">${safeName}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary batch-move-up">上移</button>
            <button type="button" class="btn btn-outline-secondary batch-move-down">下移</button>
            <button type="button" class="btn btn-outline-danger batch-remove">移除</button>
          </div>
        </td>
      </tr>`;
  }).join('');
  batchFlowList.innerHTML = rows;
}

function updateBatchSequence(){
  if (flowSequenceInput) flowSequenceInput.value = batchSelected.join(',');
}

function syncBatchList(shouldPersist){
  renderBatchList();
  updateBatchSequence();
  if (shouldPersist) persistBatchSelection();
}

function persistBatchSelection(){
  try {
    localStorage.setItem(batchStorageKey, JSON.stringify(batchSelected));
  } catch (err) {
    // Ignore storage failures
  }
}

function loadBatchSelection(){
  try {
    const raw = localStorage.getItem(batchStorageKey);
    if (!raw) return;
    const saved = JSON.parse(raw);
    if (Array.isArray(saved)) {
      batchSelected = saved.filter(Boolean);
      syncBatchList(false);
    }
  } catch (err) {
    // Ignore storage failures
  }
}

function addFlows(names){
  names.forEach(name => {
    if (!batchSelected.includes(name)) batchSelected.push(name);
  });
  syncBatchList(true);
}

function setFlowOptionsChecked(checked){
  batchFlowOptions().forEach(opt => { opt.checked = checked; });
}

if (batchFlowAddSelectedBtn){
  batchFlowAddSelectedBtn.addEventListener('click', () => {
    const selected = batchFlowOptions().filter(opt => opt.checked).map(opt => opt.value);
    if (!selected.length){
      alert('請先勾選流程');
      return;
    }
    addFlows(selected);
    const dropdownToggle = batchFlowAddSelectedBtn.closest('.dropdown')?.querySelector('[data-bs-toggle="dropdown"]');
    if (dropdownToggle){
      const inst = bootstrap.Dropdown.getOrCreateInstance(dropdownToggle);
      inst.hide();
    }
  });
}

if (batchFlowAddAllBtn){
  batchFlowAddAllBtn.addEventListener('click', () => {
    setFlowOptionsChecked(true);
  });
}
if (batchFlowClearAllBtn){
  batchFlowClearAllBtn.addEventListener('click', () => {
    setFlowOptionsChecked(false);
  });
}

if (batchFlowList){
  batchFlowList.addEventListener('click', (e) => {
    const row = e.target.closest('tr[data-flow]');
    if (!row) return;
    const name = row.getAttribute('data-flow') || '';
    const idx = batchSelected.indexOf(name);
    if (e.target.closest('.batch-remove')){
      if (idx >= 0) batchSelected.splice(idx, 1);
      const opt = batchFlowOptions().find(o => o.value === name);
      if (opt) opt.checked = false;
    } else if (e.target.closest('.batch-move-up')){
      if (idx > 0){
        batchSelected.splice(idx - 1, 0, batchSelected.splice(idx, 1)[0]);
      }
    } else if (e.target.closest('.batch-move-down')){
      if (idx >= 0 && idx < batchSelected.length - 1){
        batchSelected.splice(idx + 1, 0, batchSelected.splice(idx, 1)[0]);
      }
    }
    syncBatchList(true);
  });

  batchFlowList.addEventListener('dragstart', (e) => {
    const row = e.target.closest('tr[data-flow]');
    if (!row) return;
    draggingBatchRow = row;
    row.classList.add('dragging-row');
    try {
      e.dataTransfer.setDragImage(transparentDragImage, 0, 0);
      e.dataTransfer.setData('text/plain', row.getAttribute('data-flow') || '');
    } catch (err) {
      // Ignore drag image failures (older browsers)
    }
    e.dataTransfer.effectAllowed = 'move';
  });

  batchFlowList.addEventListener('dragover', (e) => {
    if (!draggingBatchRow) return;
    e.preventDefault();
    const row = e.target.closest('tr[data-flow]');
    if (!row || row === draggingBatchRow){
      if (dragOverRow){
        dragOverRow.classList.remove('drag-over-top', 'drag-over-bottom');
      }
      dragOverRow = null;
      dragOverPos = null;
      return;
    }
    const rect = row.getBoundingClientRect();
    const before = (e.clientY - rect.top) < rect.height / 2;
    const posClass = before ? 'drag-over-top' : 'drag-over-bottom';
    if (dragOverRow !== row || dragOverPos !== posClass){
      if (dragOverRow){
        dragOverRow.classList.remove('drag-over-top', 'drag-over-bottom');
      }
      row.classList.add(posClass);
      dragOverRow = row;
      dragOverPos = posClass;
    }
    if (before){
      batchFlowList.insertBefore(draggingBatchRow, row);
    } else {
      batchFlowList.insertBefore(draggingBatchRow, row.nextSibling);
    }
  });

  batchFlowList.addEventListener('dragend', () => {
    if (!draggingBatchRow) return;
    draggingBatchRow.classList.remove('dragging-row');
    draggingBatchRow = null;
    if (dragOverRow){
      dragOverRow.classList.remove('drag-over-top', 'drag-over-bottom');
    }
    dragOverRow = null;
    dragOverPos = null;
    batchSelected = Array.from(batchFlowList.querySelectorAll('tr[data-flow]')).map(r => r.getAttribute('data-flow'));
    syncBatchList(true);
  });
}

if (batchForm && flowSequenceInput){
  batchForm.addEventListener('submit', (e) => {
    if (!batchSelected.length){
      e.preventDefault();
      alert('請先加入要執行的流程');
      return;
    }
    syncBatchList(true);
  });
}

const batchStatusBox = document.getElementById('batchStatusBox');
async function refreshBatchStatus(){
  if (!batchStatusBox) return;
  const url = batchStatusBox.getAttribute('data-status-url');
  const resultUrl = batchStatusBox.getAttribute('data-result-url');
  if (!url) return;
  try{
    const resp = await fetch(url, { cache: 'no-store' });
    const data = await resp.json();
    if (!resp.ok || !data.ok){
      batchStatusBox.innerHTML = `<div class="text-danger">${(data && data.error) || '讀取狀態失敗'}</div>`;
      return;
    }
    const status = data.status || {};
    if (status.status === 'completed'){
      const wrap = document.getElementById('batchResultLinkWrap');
      if (wrap) wrap.style.display = '';
    }
    const flows = status.flows || [];
    const current = status.current_flow || '';
    const idx = status.current_index || 0;
    const total = flows.length || 0;
    const label = status.status || 'unknown';
    let html = `<div class="fw-semibold"執行狀態：${label}</div>`;
    if (current){
      html += `<div class="text-muted">目前流程：${current} (${idx}/${total})</div>`;
    }
    if (status.error){
      html += `<div class="text-danger">錯誤：${status.error}</div>`;
    }
    if (Array.isArray(status.results) && status.results.length){
      const rows = status.results.map(r => {
        const ok = (r.status === 'completed') || r.ok;
        return `<li>${r.flow} - ${ok ? '完成' : '失敗'}</li>`;
      }).join('');
      html += `<ul class="mb-0">${rows}</ul>`;
    }
    batchStatusBox.innerHTML = html;
  }catch(e){
    batchStatusBox.innerHTML = `<div class="text-danger">讀取狀態失敗</div>`;
  }
}

if (batchStatusBox){
  refreshBatchStatus();
  setInterval(refreshBatchStatus, 3000);
}

loadBatchSelection();
if (dropdownToggleBtn){
  dropdownToggleBtn.addEventListener('shown.bs.dropdown', () => {
    updateDropdownWidth();
  });
}
window.addEventListener('resize', () => updateDropdownWidth());
</script>
{% endblock %}
