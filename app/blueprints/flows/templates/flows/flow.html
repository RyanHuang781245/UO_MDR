{% extends "base.html" %}
{% block content %}
{% from "_file_tree.html" import render_file_tree %}
<h1 class="h3 mb-3">定義流程</h1>

<form id="flow_form" action="{{ url_for('flows_bp.run_flow', task_id=task.id) }}" method="post" class="vstack gap-3">
  <input type="hidden" name="ordered_ids" id="ordered_ids" value="">
  <input type="hidden" name="template_file" id="template_file_input" value="{{ template_file or '' }}">
  <div id="steps" class="vstack gap-3"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">流程名稱</label>
      <input class="form-control" name="flow_name" value="{{ loaded_name or '' }}">
    </div>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="center_titles" name="center_titles" {% if center_titles %}checked{% endif %}>
    <label class="form-check-label" for="center_titles">置中 Table/Figure 標題段落</label>
  </div>

  <div class="d-flex gap-2 mt-2">
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">新增步驟</button>
      <ul class="dropdown-menu">
        {% for key, meta in steps.items() %}
        <li><a class="dropdown-item" href="#" onclick="addStep('{{ key|e }}'); return false;">{{ meta.label }}</a></li>
        {% endfor %}
      </ul>
    </div>
      <button class="btn btn-success" type="submit" name="action" value="run">執行流程</button>
      <button class="btn btn-secondary" type="submit" name="action" value="save">保存流程</button>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#templateModal">模板解析</button>
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#filesModal">檔案結構</button>
    </div>
    <div class="small text-muted">目前模板：<code id="currentTemplateLabel">{{ template_file or "未選擇" }}</code></div>
  </form>

<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="templateModalLabel">模板解析</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="templateStatus" class="text-danger small mb-2"></div>
        <div class="row g-3 mb-3 align-items-end">
          <div class="col-md-7">
            <label class="form-label">選擇現有模板</label>
            <select class="form-select" id="existingTemplateSelect">
              <option value="">（從任務檔案選擇）</option>
              {% for f in files.docx %}
              <option value="{{ f }}" {% if template_file == f %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-outline-primary" type="button" id="parseExistingBtn">解析選擇檔案</button>
          </div>
        </div>
        <div class="row g-3 mb-3 align-items-end">
          <div class="col-md-9">
            <label class="form-label">上傳新模板 (docx)</label>
            <input type="file" class="form-control" id="templateUploadInput" accept=".docx">
            <div class="form-text">上傳後會存入任務的 files 目錄，並立即解析段落。</div>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" type="button" id="uploadTemplateBtn">上傳並解析</button>
          </div>
        </div>
        <div id="templatePreview" class="border rounded p-3 bg-light small">
          <div class="text-muted">尚未載入模板</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filesModalLabel">檔案結構</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-tree-container">
          {{ render_file_tree(files_tree) }}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
</div>
<hr>
<h2 class="h5 mt-4">已保存流程</h2>
<table class="table table-striped text-center align-middle" id="flowTable">
  <thead>
    <tr>
      <th class="text-start">流程名稱</th>
      <th class="text-center" style="width:180px;">建立時間</th>
      <th class="text-center" style="width:360px;">操作</th>
    </tr>
  </thead>
  <tbody id="flowTableBody">
  {% for f in flows %}
    <tr data-flow="{{ f.name }}">
      <td class="align-middle text-start">{{ f.name }}</td>
      <td class="align-middle">{{ f.created }}</td>
      <td class="align-middle">
        <form action="{{ url_for('flows_bp.execute_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" {% if f.has_copy %}onsubmit="return confirm('\u6d41\u7a0b\u5305\u542b\u8907\u88fd\u6a94\u6848\u6b65\u9a5f\uff0c\u57f7\u884c\u524d\u8acb\u78ba\u8a8d NAS \u8207\u4efb\u52d9\u8cc7\u6599\u593e\u5167\u5bb9\u4e00\u81f4\u3002')"{% endif %}>
          <button class="btn btn-sm btn-outline-success">執行</button>
        </form>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('flows_bp.flow_builder', task_id=task.id, flow=f.name) }}">編輯</a>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="renameFlow('{{ f.name }}')">重新命名</button>
        <form action="{{ url_for('flows_bp.delete_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" onsubmit="return confirm('\u78ba\u5b9a\u522a\u9664?')">
          <button class="btn btn-sm btn-outline-danger">刪除</button>
        </form>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('flows_bp.export_flow', task_id=task.id, flow_name=f.name) }}">匯出</a>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="3">尚無流程</td></tr>
  {% endfor %}
  </tbody>
</table>

<div class="mt-3">
  <a class="btn btn-outline-primary" href="{{ url_for('flows_bp.flow_batch_page', task_id=task.id) }}">批次背景執行</a>
</div>



<form action="{{ url_for('flows_bp.import_flow', task_id=task.id) }}" method="post" enctype="multipart/form-data" class="mt-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-6">
      <label class="form-label">匯入流程 JSON</label>
      <input class="form-control" type="file" name="flow_file" required>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-primary" type="submit">匯入</button>
    </div>
  </div>
</form>


<script>
const TASK_ID = '{{ task.id }}';
const SUPPORTED_STEPS = {{ steps|tojson }};
const AVAILABLE_FILES = {{ files|tojson }};
const PRESET_FLOW = {{ preset|tojson }};
const TEMPLATE_PARSE_URL = "{{ url_for('tasks_bp.parse_template_doc', task_id=task.id) }}";
const TEMPLATE_FILE = {{ template_file|tojson }};
const TEMPLATE_PARAGRAPHS = {{ template_paragraphs|tojson }};
const BOOL_DEFAULTS = {
  include_caption: "false",
  target_title: "false"
};

const FIELD_META = {
  pdf_zip: {
    label: "PDF ZIP 壓縮檔"
  },
  target_section: {
    label: "章節編號",
    placeholder: "例如 6.12.1"
  },
  target_chapter_section: {
    label: "章節編號",
    placeholder: "例如 6.12.1"
  },
  target_title_section: {
    label: "章節標題",
    placeholder: "請輸入完整章節標題"
  },
  target_subtitle: {
    label: "小標題",
    placeholder: "請完整輸入小標題"
  },
  target_figure_label: {
    label: "目標圖號",
    placeholder: "例如 Figure 1"
  },
  target_table_label: {
    label: "目標表號",
    placeholder: "例如 Table 1"
  },
  input_file: {
    label: "輸入檔案",
    placeholder: "請選擇檔案"
  },
  template_index: {
    label: "模板段落"
  },
  template_mode: {
    label: "插入方式"
  },
  keywords: {
    label: "關鍵字",
    placeholder: "以逗號分隔，例如 a,b,c"
  },
  target_title: {
    label: "擷取標題內容"
  },
  subheading_text: {
    label: "小標題",
    placeholder: "請完整輸入小標題"
  },
  explicit_end_title: {
    label: "強制結束標題",
    placeholder: "強制指定章節結束，請完整輸入標題"
  },
  ignore_toc: {
    label: "移除目錄"
  },
  ignore_toc_and_before: {
    label: "移除目錄及前言"
  },
  ignore_header_footer: {
    label: "移除頁首頁尾"
  },
  text: {
    label: "輸入文字",
    placeholder: "請輸入文字內容"
  },
  align: {
    label: "對齊方式"
  },
  bold: {
    label: "粗體"
  },
  source_dir: {
    label: "來源資料夾"
  },
  dest_dir: {
    label: "目的資料夾"
  },
};

const templateFileInput = document.getElementById('template_file_input');
const currentTemplateLabel = document.getElementById('currentTemplateLabel');
const templatePreview = document.getElementById('templatePreview');
const templateStatus = document.getElementById('templateStatus');
const existingTemplateSelect = document.getElementById('existingTemplateSelect');
const parseExistingBtn = document.getElementById('parseExistingBtn');
const templateUploadInput = document.getElementById('templateUploadInput');
const uploadTemplateBtn = document.getElementById('uploadTemplateBtn');

let templateFile = TEMPLATE_FILE || "";
let templateParagraphs = TEMPLATE_PARAGRAPHS || [];

function escapeHtml(str){
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;",
  }[m] || m));
}

function formatTemplateLabel(p){
  const disp = (p.display || "").trim();
  const txt = (p.text || "").trim();
  const label = [disp, txt].filter(Boolean).join(" ");
  return `[${p.index}] ${label}`.trim();
}

function buildTemplateOptions(current){
  let opts = `<option value="" ${current ? "" : "selected"}>${templateParagraphs.length ? "不插入模板" : "請先解析模板"}</option>`;
  for (const p of templateParagraphs){
    const selected = String(p.index) === String(current) ? "selected" : "";
    opts += `<option value="${p.index}" ${selected}>${escapeHtml(formatTemplateLabel(p))}</option>`;
  }
  return opts;
}

function refreshTemplateSelects(){
  document.querySelectorAll('select[data-template-select="1"]').forEach(sel => {
    const current = sel.value;
    sel.innerHTML = buildTemplateOptions(current);
    sel.disabled = templateParagraphs.length === 0;
  });
}

function renderTemplatePreview(){
  if (!templatePreview) return;
  if (!templateFile){
    templatePreview.innerHTML = '<div class="text-muted">尚未載入模板</div>';
    if (currentTemplateLabel) currentTemplateLabel.textContent = "未選擇";
    return;
  }
  if (currentTemplateLabel) currentTemplateLabel.textContent = templateFile;
  const rows = (templateParagraphs || []).map(p => {
    return `<tr><td class="mono">${p.index}</td><td class="mono">${escapeHtml(p.display || "")}</td><td>${escapeHtml(p.text || "")}</td></tr>`;
  }).join("") || '<tr><td colspan="3" class="text-center text-muted">尚未解析到段落</td></tr>';
  templatePreview.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>當前模板：<code>${escapeHtml(templateFile)}</code></div>
      <div class="text-muted small">段落總數：${templateParagraphs.length}</div>
    </div>
    <div class="table-responsive" style="max-height:320px; overflow:auto;">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light"><tr><th style="width:100px;">index</th><th style="width:140px;">display</th><th>text</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function loadTemplateFromServer(formData){
  if (templateStatus) templateStatus.textContent = "";
  const resp = await fetch(TEMPLATE_PARSE_URL, { method: "POST", body: formData });
  let data = {};
  try { data = await resp.json(); } catch (e) { /* ignore */ }
  if (!resp.ok || !data.ok){
    const err = data.error || "解析模板失敗，請稍後重試";
    if (templateStatus) templateStatus.textContent = err;
    throw new Error(err);
  }
  templateFile = data.template_file || "";
  templateParagraphs = data.paragraphs || [];
  if (templateFileInput) templateFileInput.value = templateFile;
  renderTemplatePreview();
  refreshTemplateSelects();
  markDirty();
}

let isInitialising = true;
let isDirty = false;
function markDirty(){
  if (!isInitialising) isDirty = true;
}
window.addEventListener('beforeunload', function(e){
  if (!isDirty) return;
  e.preventDefault();
  e.returnValue = '';
});
const flowForm = document.getElementById('flow_form');
flowForm.addEventListener('submit', (e) => {
  const action = e.submitter?.value;
  if ((action === 'save' || action === 'run') && !flowForm.elements['flow_name'].value.trim()) {
    e.preventDefault();
    alert('請輸入流程名稱');
    return;
  }
  if (action === 'run') {
    const hasCopy = Array.from(flowForm.querySelectorAll('input[name$="_type"]'))
      .some(el => el.value === 'copy_files');
    if (hasCopy && !confirm('此流程包含複製檔案步驟，確定要執行嗎？')) {
      e.preventDefault();
      return;
    }
    const wantsTemplate = Array.from(flowForm.querySelectorAll('select[data-template-select="1"]'))
      .some(sel => sel.value);
    const hasTemplate = (templateFileInput?.value || "").trim().length > 0;
    if (wantsTemplate && !hasTemplate){
      e.preventDefault();
      alert('已選擇模板段落但尚未載入模板，請先解析模板');
      return;
    }
  }
  isDirty = false;
});
flowForm.addEventListener('input', markDirty);
flowForm.addEventListener('change', markDirty);
if (parseExistingBtn){
  parseExistingBtn.addEventListener('click', async () => {
    const chosen = existingTemplateSelect?.value || "";
    if (!chosen){
      if (templateStatus) templateStatus.textContent = "請先選擇模板檔案";
      return;
    }
    const fd = new FormData();
    fd.append("template_path", chosen);
    try {
      await loadTemplateFromServer(fd);
    } catch (err) {
      console.error(err);
    }
  });
}
if (uploadTemplateBtn){
  uploadTemplateBtn.addEventListener('click', async () => {
    const file = templateUploadInput?.files?.[0];
    if (!file){
      if (templateStatus) templateStatus.textContent = "請選擇要上傳的模板檔案";
      return;
    }
    const fd = new FormData();
    fd.append("template_file", file);
    try {
      await loadTemplateFromServer(fd);
      if (existingTemplateSelect && templateFile){
        if (!Array.from(existingTemplateSelect.options).some(o => o.value === templateFile)){
          const opt = document.createElement("option");
          opt.value = templateFile;
          opt.textContent = templateFile;
          existingTemplateSelect.appendChild(opt);
        }
        existingTemplateSelect.value = templateFile;
      }
    } catch (err) {
      console.error(err);
    } finally {
      if (templateUploadInput) templateUploadInput.value = "";
    }
  });
}
renderTemplatePreview();
refreshTemplateSelects();
function genId(){ return (Date.now().toString(36) + Math.random().toString(36).slice(2,7)); }
function updateOrder(){
  const ids = Array.from(document.querySelectorAll("#steps .card")).map(el => el.dataset.sid);
  document.getElementById("ordered_ids").value = ids.join(",");
  markDirty();
}
function addStep(typeKey, preset={}, refSid=null, position='end'){
  const spec = SUPPORTED_STEPS[typeKey];
  const sid = genId();
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.sid = sid;

  let menuBefore = '', menuAfter = '';
  for (const [k, m] of Object.entries(SUPPORTED_STEPS)){
    menuBefore += `<li><a class="dropdown-item" href="#" onclick="addStep('${k}', {}, '${sid}', 'before'); return false;">${m.label}</a></li>`;
    menuAfter  += `<li><a class="dropdown-item" href="#" onclick="addStep('${k}', {}, '${sid}', 'after'); return false;">${m.label}</a></li>`;
  }

  let body = `<div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">${spec.label}</h2>
      <div class="btn-group">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入上方</button>
          <ul class="dropdown-menu">${menuBefore}</ul>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入下方</button>
          <ul class="dropdown-menu">${menuAfter}</ul>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp('${sid}')">上移</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown('${sid}')">下移</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${sid}')">刪除</button>
      </div>
    </div>
    <input type="hidden" name="step_${sid}_type" value="${typeKey}">
    <div class="row g-3 mt-1">`;

  for (const k of spec.inputs){
    const accept = spec.accepts[k];
    const meta = FIELD_META[k] || {};
    const label = meta.label || k;
    const placeholder = meta.placeholder || label;

    const rawVal = preset[k];
    const val = rawVal === undefined || rawVal === null ? "" : String(rawVal);
    if (k === "template_index"){
      const disabled = templateParagraphs.length === 0 ? "disabled" : "";
      body += `<div class="col-md-6"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_template_index" data-template-select="1" ${disabled}>
                 ${buildTemplateOptions(val)}
               </select>
               <div class="form-text">${templateParagraphs.length ? "選擇要插入的位置（段落 index）" : "請先解析模板"}</div>
             </div>`;
      continue;
    } else if (k === "template_mode") {
      const modeVal = val || "insert_after";
      body += `<div class="col-md-3"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_template_mode">
                 <option value="insert_after" ${modeVal==="insert_after"?"selected": ""}>段落後新增</option>
                 <option value="replace" ${modeVal==="replace"?"selected": ""}>取代該段落</option>
               </select></div>`;
      continue;
    }
    if (accept === "text"){
      body += `<div class="col-md-6"><label class="form-label">${label}</label>
               <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
    } else if (accept === "bool"){
      const boolDefault = BOOL_DEFAULTS[k] || "true";
      const boolVal = val === "" ? boolDefault : val;
      body += `<div class="col-md-3"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}">
                 <option value="false" ${boolVal==="false"?"selected": ""}>否</option>
                 <option value="true" ${boolVal!=="false"?"selected": ""}>是</option>
               </select>
             </div>`;
    } else if (accept === "int" || accept === "float"){
      if (k === "level") {
        let options = "", help = "";
        if (typeKey === "insert_numbered_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（1.）</option>
                     <option value="1" ${val==="1"?"selected": ""}>Level 1（1.1.）</option>
                     <option value="2" ${val==="2"?"selected": ""}>Level 2（1.1.1.）</option>`;
          help = "建議僅用到 Level 2；更深層需先擴充樣式。";
        } else if (typeKey === "insert_roman_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（I.）</option>`;
          help = "僅定義 Level 0；要 I→A→1 多層需擴充樣式。";
        } else {
          options = `<option value="0" ${val==="0"?"selected": ""}>0</option>`;
        }
        body += `<div class="col-md-4">
                   <label class="form-label">level</label>
                   <select class="form-select" name="step_${sid}_${k}">${options}</select>
                   <div class="form-text">${help}</div>
                 </div>`;
      } else if (k === "font_size") {
        body += `<div class="col-md-3"><label class="form-label">字體大小</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="12" ${val==="12"?"selected": ""}>12</option>
                   <option value="13" ${val==="13"?"selected": ""}>13</option>
                   <option value="14" ${val==="14"?"selected": ""}>14</option>
                   <option value="16" ${val==="16"?"selected": ""}>16</option>
                   <option value="18" ${val==="18"?"selected": ""}>18</option>
                 </select></div>`;
      } else if (k === "before_space" || k === "after_space") {
        const nice = k === "before_space" ? "段前間距" : "段後間距";
        body += `<div class="col-md-3"><label class="form-label">${nice}</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="0" ${val==="0"?"selected": ""}>0 pt</option>
                   <option value="6" ${val==="6"?"selected": ""}>6 pt</option>
                   <option value="12" ${val==="12"?"selected": ""}>12 pt</option>
                 </select></div>`;
      } else {
        body += `<div class="col-md-3"><label class="form-label">${label}</label>
                 <input class="form-control" type="number" step="any" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
      }
    } else if (accept.startsWith("file")){
      const ext = accept.split(":")[1];
      const options = (AVAILABLE_FILES[ext] || []).map(f => `<option value="${f}" ${val===f?"selected": ""}>${f}</option>`).join("");
      const placeholder = ext === "dir" ? "選擇資料夾" : "選擇檔案";
      const selected = val ? "" : "selected";
      body += `<div class="col-md-6"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}" required>
                 <option value="" disabled ${selected}>${placeholder}</option>${options}
               </select></div>`;
    } else if (k === "align"){
      body += `<div class="col-md-3"><label class="form-label">對齊</label>
               <select class="form-select" name="step_${sid}_align">
                 <option value="left" ${val==="left"?"selected": ""}>靠左</option>
                 <option value="center" ${val==="center"?"selected": ""}>置中</option>
                 <option value="right" ${val==="right"?"selected": ""}>靠右</option>
                 <option value="justify" ${val==="justify"?"selected": ""}>左右對齊</option>
               </select>
               <div class="form-text">一般內文建議使用 左/左右對齊；標題多用 置中。</div>
             </div>`;
    }
  }

  body += `</div></div>`;
  card.innerHTML = body;
  const container = document.getElementById("steps");
  if (refSid){
    const ref = document.querySelector(`.card[data-sid="${refSid}"]`);
    if (ref){
      if (position === 'before'){
        container.insertBefore(card, ref);
      } else {
        container.insertBefore(card, ref.nextSibling);
      }
    } else {
      container.appendChild(card);
    }
  } else {
    container.appendChild(card);
  }
  refreshTemplateSelects();
  updateOrder();
}
function removeStep(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (el) el.remove();
  updateOrder();
}
function moveUp(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (!el) return;
  const prev = el.previousElementSibling;
  if (prev) el.parentNode.insertBefore(el, prev);
  updateOrder();
}
function moveDown(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (!el) return;
  const next = el.nextElementSibling;
  if (next) el.parentNode.insertBefore(next, el);
  updateOrder();
}
function renameFlow(current){
  const name = prompt('輸入新流程名稱', current);
  if(!name) return;
  const form = document.createElement('form');
  form.method = 'post';
  form.action = `/tasks/${TASK_ID}/flows/rename/${current}`;
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'name';
  input.value = name;
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}
if (PRESET_FLOW){
  for (const st of PRESET_FLOW){
    addStep(st.type, st.params);
  }
}
isInitialising = false;
</script>

{% endblock %}
