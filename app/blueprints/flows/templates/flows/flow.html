{% extends "base.html" %}
{% block content %}
{% from "_file_tree.html" import render_file_tree %}

<div id="runStatusContainer" class="run-status-container"></div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
  <h1 class="h3 mb-0 fw-bold">流程管理</h1>
  <!-- <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1" href="{{ url_for('tasks_bp.task_detail', task_id=task.id) }}">
      <i class="bi bi-arrow-left"></i>
      返回任務詳情
    </a>
    <a class="btn btn-sm btn-secondary d-inline-flex align-items-center gap-1" href="{{ url_for('flows_bp.flow_results', task_id=task.id) }}">
      <i class="bi bi-clipboard-check"></i>
      流程執行結果
    </a>
    <a class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" href="{{ url_for('flows_bp.flow_batch_page', task_id=task.id) }}">
      <i class="bi bi-calendar2-week"></i>
      進入排程管理
    </a>
  </div> -->
</div>

<div class="card shadow-sm border mb-4">
  <form id="flow_form" action="{{ url_for('flows_bp.run_flow', task_id=task.id) }}" method="post">
    <input type="hidden" name="ordered_ids" id="ordered_ids" value="">
    <input type="hidden" name="template_file" id="template_file_input" value="{{ template_file or '' }}">

    <div class="card-body border-bottom">
      <div class="row g-3">
        <div class="col-lg-7">
          <label class="form-label text-muted small">流程名稱</label>
          <input class="form-control" name="flow_name" placeholder="請輸入流程名稱..." value="{{ loaded_name or '' }}">
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="center_titles" name="center_titles" {% if center_titles %}checked{% endif %}>
            <label class="form-check-label" for="center_titles">置中 Table/Figure 標題段落</label>
          </div>
        </div>
      </div>
    </div>

    <div class="px-4 py-3 bg-light border-bottom">
      <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
        <div class="d-flex flex-wrap gap-2">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle d-inline-flex align-items-center gap-1" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-plus-lg"></i>
              新增步驟
            </button>
            <ul class="dropdown-menu">
              {% for key, meta in steps.items() %}
              <li><a class="dropdown-item" href="#" onclick="addStep('{{ key|e }}'); return false;">{{ meta.label }}</a></li>
              {% endfor %}
            </ul>
          </div>
          <button class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" type="button" data-bs-toggle="modal" data-bs-target="#templateModal">
            <i class="bi bi-search"></i>
            模板解析
          </button>
          <button class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" type="button" data-bs-toggle="modal" data-bs-target="#filesModal">
            <i class="bi bi-folder"></i>
            檔案結構
          </button>
          <button class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" type="button" id="toggleAllStepsBtn">
            <i class="bi bi-arrows-collapse"></i>
            全部收合
          </button>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button class="btn btn-outline-primary d-inline-flex align-items-center gap-1" type="submit" name="action" value="save">
            <i class="bi bi-save"></i>
            保存流程
          </button>
          <!-- <a class="btn btn-primary d-inline-flex align-items-center gap-1" href="{{ url_for('flows_bp.flow_batch_page', task_id=task.id) }}">
            <i class="bi bi-calendar2-week"></i>
            進入排程管理
          </a> -->
        </div>
      </div>
      <div class="small text-muted mt-2">
        目前模板：<code id="currentTemplateLabel">{{ template_file or "未選擇" }}</code>
      </div>
    </div>

    <div class="card-body">
      <div id="steps" class="vstack gap-3"></div>
    </div>
  </form>
</div>

<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="templateModalLabel">模板解析</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="templateStatus" class="text-danger small mb-2"></div>
        <div class="row g-3 mb-3 align-items-end">
          <div class="col-md-7">
            <label class="form-label">選擇現有模板</label>
            <select class="form-select" id="existingTemplateSelect">
              <option value="">（從任務檔案選擇）</option>
              {% for f in files.docx %}
              <option value="{{ f }}" {% if template_file == f %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-outline-primary" type="button" id="parseExistingBtn">解析選擇檔案</button>
          </div>
        </div>
        <div class="row g-3 mb-3 align-items-end">
          <div class="col-md-9">
            <label class="form-label">上傳新模板 (docx)</label>
            <input type="file" class="form-control" id="templateUploadInput" accept=".docx">
            <div class="form-text">上傳後會存入任務的 files 目錄，並立即解析段落。</div>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" type="button" id="uploadTemplateBtn">上傳並解析</button>
          </div>
        </div>
        <div id="templatePreview" class="border rounded p-3 bg-light small">
          <div class="text-muted">尚未載入模板</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filesModalLabel">檔案結構</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="file-tree-container">
          {{ render_file_tree(files_tree) }}
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="applyFormattingModal" tabindex="-1" aria-labelledby="applyFormattingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="applyFormattingForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="applyFormattingModalLabel">套用字型/行距</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="apply_formatting" value="true">
          <div class="mb-3">
            <label class="form-label">字型</label>
            <select class="form-select" name="document_format">
              {% for key, preset in document_format_presets.items() %}
              <option value="{{ key }}" {% if document_format == key %}selected{% endif %}>{{ preset.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">行距</label>
            <select class="form-select" name="line_spacing">
              {% for key, label in line_spacing_choices %}
              <option value="{{ key }}" {% if line_spacing == key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">&#21462;&#28040;</button>
          <button type="submit" class="btn btn-success">套用並執行</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card shadow-sm border mt-4">
  <div class="card-header bg-white border-bottom">
    <h2 class="h5 mb-0 fw-bold">已保存流程</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped text-center align-middle flow-table mb-0" id="flowTable">
        <thead>
          <tr>
              <th class="text-start ps-3">流程名稱</th>
              <th class="text-center" style="width: 200px;">建立時間</th>
              <th class="text-center" style="width: 300px;">操作</th>
          </tr>
        </thead>
        <tbody id="flowTableBody">
        {% for f in flows %}
          <tr data-flow="{{ f.name }}">
            <td class="align-middle text-start ps-3">{{ f.name }}</span></td>
            <td class="align-middle">{{ f.created }}</td>
            <td class="align-middle">
              <div class="d-inline-flex flex-wrap gap-1 justify-content-center">
                <form action="{{ url_for('flows_bp.execute_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" {% if f.has_copy %}onsubmit="return confirm('\u6d41\u7a0b\u5305\u542b\u8907\u88fd\u6a94\u6848\u6b65\u9a5f\uff0c\u57f7\u884c\u524d\u8acb\u78ba\u8a8d NAS \u8207\u4efb\u52d9\u8cc7\u6599\u593e\u5167\u5bb9\u4e00\u81f4\u3002')"{% endif %}>
                  <input type="hidden" name="apply_formatting" value="false">
                  
                  <button class="btn btn-sm btn-success d-inline-flex align-items-center gap-1">
                    <i class="bi bi-play-fill"></i>
                    執行
                  </button>
                </form>
                <button class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1 apply-formatting-btn"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#applyFormattingModal"
                        data-flow="{{ f.name }}"
                        data-action="{{ url_for('flows_bp.execute_flow', task_id=task.id, flow_name=f.name) }}">
                  <i class="bi bi-text-paragraph"></i>
                  &#22871;&#29992;&#23383;&#22411;/&#34892;&#36317;
                </button>
                <a class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1" href="{{ url_for('flows_bp.flow_builder', task_id=task.id, flow=f.name) }}">
                  <i class="bi bi-pencil-square"></i>
                  編輯
                </a>
                <button class="btn btn-sm btn-secondary d-inline-flex align-items-center gap-1" type="button" onclick="renameFlow('{{ f.name }}')">
                  <i class="bi bi-pencil"></i>
                  重新命名
                </button>
                <form action="{{ url_for('flows_bp.delete_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" onsubmit="return confirm('\u78ba\u5b9a\u522a\u9664?')">
                  <button class="btn btn-sm btn-danger d-inline-flex align-items-center gap-1">
                    <i class="bi bi-trash"></i>
                    刪除
                  </button>
                </form>
              </div>
              <!-- <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('flows_bp.export_flow', task_id=task.id, flow_name=f.name) }}">匯出</a> -->
            </td>
          </tr>
        {% else %}
          <tr><td colspan="3">尚無流程</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<style>
.flow-table {
  table-layout: fixed;
  width: 100%;
}
.flow-table th,
.flow-table td {
  width: 33.3333%;
}
.run-status-container {
  position: fixed;
  top: 88px;
  right: 24px;
  z-index: 1050;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.run-status-toast {
  min-width: 240px;
  max-width: 360px;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #e6e6e2;
  background: #ffffff;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}
.run-status-title {
  font-weight: 700;
  margin-bottom: 4px;
}
.run-status-body {
  color: #555;
  font-size: 0.9rem;
}
.step-toggle[aria-expanded="true"] .transition-icon {
  transform: rotate(90deg);
}
.transition-icon {
  transition: transform 0.2s ease;
}
</style>


<script>
const TASK_ID = '{{ task.id }}';
const SUPPORTED_STEPS = {{ steps|tojson }};
const AVAILABLE_FILES = {{ files|tojson }};
const PRESET_FLOW = {{ preset|tojson }};
const TEMPLATE_PARSE_URL = "{{ url_for('tasks_bp.parse_template_doc', task_id=task.id) }}";
const TEMPLATE_FILE = {{ template_file|tojson }};
const TEMPLATE_PARAGRAPHS = {{ template_paragraphs|tojson }};
const ACTIVE_RUNS_URL = "{{ url_for('flows_bp.flow_run_active', task_id=task.id) }}";
const BOOL_DEFAULTS = {
  include_caption: "false",
  use_chapter_title: "false"
};

const FIELD_META = {
  pdf_zip: {
    label: "PDF ZIP 壓縮檔"
  },
  target_section: {
    label: "章節編號",
    placeholder: "例如 6.12.1"
  },
  target_chapter_section: {
    label: "章節編號",
    placeholder: "例如 6.12.1"
  },
  target_chapter_title: {
    label: "章節標題",
    placeholder: "請輸入完整章節標題"
  },
  target_subtitle: {
    label: "小標題",
    placeholder: "請完整輸入小標題"
  },
  subheading_strict_match: {
    label: "小標題精確比對"
  },
  target_caption_label: {
    label: "圖/表標題前綴",
    placeholder: "例如 Figure 1 或 Table 1"
  },
  input_file: {
    label: "輸入檔案",
    placeholder: "請選擇檔案"
  },
  template_index: {
    label: "模板段落"
  },
  template_mode: {
    label: "插入方式"
  },
  keywords: {
    label: "關鍵字",
    placeholder: "以逗號分隔，例如 a,b,c"
  },
  use_chapter_title: {
    label: "擷取小標題內容"
  },
  page_break_before: {
    label: "段落前換頁"
  },
  explicit_end_title: {
    label: "強制結束標題",
    placeholder: "強制指定章節結束，請完整輸入標題"
  },
  ignore_toc: {
    label: "移除目錄及前言"
  },
  ignore_header_footer: {
    label: "移除頁首頁尾"
  },
  include_caption: {
    label: "包含標題"
  },
  text: {
    label: "輸入文字",
    placeholder: "請輸入文字內容"
  },
  align: {
    label: "對齊方式"
  },
  bold: {
    label: "粗體"
  },
  source_dir: {
    label: "來源資料夾"
  },
  dest_dir: {
    label: "目的資料夾"
  },
};

const RUN_JOB_ID = {{ job_id|tojson }};
const runStatusContainer = document.getElementById("runStatusContainer");
const runStatusStorageKey = `flowRunStatus:${TASK_ID}`;
const applyFormattingModal = document.getElementById("applyFormattingModal");
const applyFormattingForm = document.getElementById("applyFormattingForm");
const applyFormattingTitle = document.getElementById("applyFormattingModalLabel");
if (applyFormattingModal) {
  applyFormattingModal.addEventListener("show.bs.modal", (event) => {
    const btn = event.relatedTarget;
    if (!btn) return;
    const action = btn.getAttribute("data-action");
    const flowName = btn.getAttribute("data-flow");
    if (applyFormattingForm && action) applyFormattingForm.action = action;
    if (applyFormattingTitle && flowName) {
      applyFormattingTitle.textContent = `套用字型/行距 - ${flowName}`;
    }
  });
}

const { submitPostForm, escapeHtml } = window.UiUtils;

function buildInsertMenu(sid, position){
  return Object.entries(SUPPORTED_STEPS).map(([key, meta]) => (
    `<li><a class="dropdown-item" href="#" onclick="addStep('${key}', {}, '${sid}', '${position}'); return false;">${meta.label}</a></li>`
  )).join('');
}

function loadRunJobs(){
  try {
    const raw = localStorage.getItem(runStatusStorageKey);
    const data = JSON.parse(raw || "[]");
    return Array.isArray(data) ? data.filter(Boolean) : [];
  } catch (e) {
    return [];
  }
}

function saveRunJobs(list){
  try {
    localStorage.setItem(runStatusStorageKey, JSON.stringify(list));
  } catch (e) {
    // ignore
  }
}

function ensureRunJob(jobId){
  if (!jobId) return;
  const list = loadRunJobs();
  if (!list.includes(jobId)) {
    list.push(jobId);
    saveRunJobs(list);
  }
}

function removeRunJob(jobId){
  const list = loadRunJobs().filter(id => id !== jobId);
  saveRunJobs(list);
  const node = runStatusContainer?.querySelector(`[data-job-id="${jobId}"]`);
  if (node) node.remove();
}

function renderRunToasts(){
  if (!runStatusContainer) return;
  const list = loadRunJobs();
  runStatusContainer.innerHTML = "";
  list.forEach(jobId => {
    const toast = document.createElement("div");
    toast.className = "run-status-toast";
    toast.dataset.jobId = jobId;
    toast.dataset.statusUrl = `{{ url_for('flows_bp.flow_run_status', task_id=task.id, job_id='__JOB__') }}`.replace("__JOB__", jobId);
    toast.innerHTML = `
      <div class="run-status-title">流程執行中</div>
      <div class="run-status-body">正在執行：<span class="run-status-name">（讀取中）</span></div>
    `;
    runStatusContainer.appendChild(toast);
  });
}

async function refreshRunStatus(){
  if (!runStatusContainer) return;
  const toasts = Array.from(runStatusContainer.querySelectorAll(".run-status-toast"));
  for (const toast of toasts){
    const url = toast.dataset.statusUrl;
    if (!url) continue;
    try{
      const resp = await fetch(url, { cache: "no-store" });
      const data = await resp.json();
      if (!resp.ok || !data.ok){
        removeRunJob(toast.dataset.jobId);
        continue;
      }
      const status = data.status || "unknown";
      const flowName = data.flow_name || "（未命名）";
      const titleEl = toast.querySelector(".run-status-title");
      const bodyEl = toast.querySelector(".run-status-body");
      const nameEl = toast.querySelector(".run-status-name");
      if (nameEl) nameEl.textContent = flowName;
      if (status === "completed"){
        if (titleEl) titleEl.textContent = "流程已完成";
        if (bodyEl) bodyEl.textContent = `已完成：${flowName}`;
        setTimeout(() => removeRunJob(toast.dataset.jobId), 4000);
        continue;
      }
      if (status === "failed"){
        if (titleEl) titleEl.textContent = "流程失敗";
        if (bodyEl) bodyEl.textContent = `失敗：${flowName}`;
        continue;
      }
      if (titleEl) titleEl.textContent = status === "queued" ? "流程排隊中" : "流程執行中";
      if (bodyEl) bodyEl.textContent = `${status === "queued" ? "排隊中" : "正在執行"}：${flowName}`;
    }catch(e){
      // ignore
    }
  }
}

async function syncActiveRuns(){
  try{
    const resp = await fetch(ACTIVE_RUNS_URL, { cache: "no-store" });
    const data = await resp.json();
    if (!resp.ok || !data.ok) return;
    const serverRuns = Array.isArray(data.runs) ? data.runs : [];
    serverRuns.forEach(r => ensureRunJob(r.job_id));
    renderRunToasts();
  }catch(e){
    // ignore
  }
}

if (RUN_JOB_ID){
  ensureRunJob(RUN_JOB_ID);
}
renderRunToasts();
if (runStatusContainer){
  refreshRunStatus();
  setInterval(refreshRunStatus, 3000);
  syncActiveRuns();
  setInterval(syncActiveRuns, 10000);
}

const templateFileInput = document.getElementById('template_file_input');
const currentTemplateLabel = document.getElementById('currentTemplateLabel');
const templatePreview = document.getElementById('templatePreview');
const templateStatus = document.getElementById('templateStatus');
const existingTemplateSelect = document.getElementById('existingTemplateSelect');
const parseExistingBtn = document.getElementById('parseExistingBtn');
const templateUploadInput = document.getElementById('templateUploadInput');
const uploadTemplateBtn = document.getElementById('uploadTemplateBtn');

let templateFile = TEMPLATE_FILE || "";
let templateParagraphs = TEMPLATE_PARAGRAPHS || [];

function formatTemplateLabel(p){
  const disp = (p.display || "").trim();
  const txt = (p.text || "").trim();
  const label = [disp, txt].filter(Boolean).join(" ");
  return `[${p.index}] ${label}`.trim();
}

function buildTemplateOptions(current){
  let opts = `<option value="" ${current ? "" : "selected"}>${templateParagraphs.length ? "不插入模板" : "請先解析模板"}</option>`;
  for (const p of templateParagraphs){
    const selected = String(p.index) === String(current) ? "selected" : "";
    opts += `<option value="${p.index}" ${selected}>${escapeHtml(formatTemplateLabel(p))}</option>`;
  }
  return opts;
}

function refreshTemplateSelects(){
  document.querySelectorAll('select[data-template-select="1"]').forEach(sel => {
    const current = sel.value;
    sel.innerHTML = buildTemplateOptions(current);
    sel.disabled = templateParagraphs.length === 0;
  });
}

function renderTemplatePreview(){
  if (!templatePreview) return;
  if (!templateFile){
    templatePreview.innerHTML = '<div class="text-muted">尚未載入模板</div>';
    if (currentTemplateLabel) currentTemplateLabel.textContent = "未選擇";
    return;
  }
  if (currentTemplateLabel) currentTemplateLabel.textContent = templateFile;
  const rows = (templateParagraphs || []).map(p => {
    return `<tr><td class="mono">${p.index}</td><td class="mono">${escapeHtml(p.display || "")}</td><td>${escapeHtml(p.text || "")}</td></tr>`;
  }).join("") || '<tr><td colspan="3" class="text-center text-muted">尚未解析到段落</td></tr>';
  templatePreview.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>當前模板：<code>${escapeHtml(templateFile)}</code></div>
      <div class="text-muted small">段落總數：${templateParagraphs.length}</div>
    </div>
    <div class="table-responsive" style="max-height:320px; overflow:auto;">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light"><tr><th style="width:100px;">index</th><th style="width:140px;">display</th><th>text</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function loadTemplateFromServer(formData){
  if (templateStatus) templateStatus.textContent = "";
  const resp = await fetch(TEMPLATE_PARSE_URL, { method: "POST", body: formData });
  let data = {};
  try { data = await resp.json(); } catch (e) { /* ignore */ }
  if (!resp.ok || !data.ok){
    const err = data.error || "解析模板失敗，請稍後重試";
    if (templateStatus) templateStatus.textContent = err;
    throw new Error(err);
  }
  templateFile = data.template_file || "";
  templateParagraphs = data.paragraphs || [];
  if (templateFileInput) templateFileInput.value = templateFile;
  renderTemplatePreview();
  refreshTemplateSelects();
  markDirty();
}

let isInitialising = true;
let isDirty = false;
function markDirty(){
  if (!isInitialising) isDirty = true;
}
window.addEventListener('beforeunload', function(e){
  if (!isDirty) return;
  e.preventDefault();
  e.returnValue = '';
});
const flowForm = document.getElementById('flow_form');
flowForm.addEventListener('submit', (e) => {
  const action = e.submitter?.value;
  if ((action === 'save' || action === 'run') && !flowForm.elements['flow_name'].value.trim()) {
    e.preventDefault();
    alert('請輸入流程名稱');
    return;
  }
  if (action === 'run') {
    const hasCopy = Array.from(flowForm.querySelectorAll('input[name$="_type"]'))
      .some(el => el.value === 'copy_files');
    if (hasCopy && !confirm('此流程包含複製檔案步驟，確定要執行嗎？')) {
      e.preventDefault();
      return;
    }
    const wantsTemplate = Array.from(flowForm.querySelectorAll('select[data-template-select="1"]'))
      .some(sel => sel.value);
    const hasTemplate = (templateFileInput?.value || "").trim().length > 0;
    if (wantsTemplate && !hasTemplate){
      e.preventDefault();
      alert('已選擇模板段落但尚未載入模板，請先解析模板');
      return;
    }
  }
  isDirty = false;
});
flowForm.addEventListener('input', markDirty);
flowForm.addEventListener('change', markDirty);
if (parseExistingBtn){
  parseExistingBtn.addEventListener('click', async () => {
    const chosen = existingTemplateSelect?.value || "";
    if (!chosen){
      if (templateStatus) templateStatus.textContent = "請先選擇模板檔案";
      return;
    }
    const fd = new FormData();
    fd.append("template_path", chosen);
    try {
      await loadTemplateFromServer(fd);
    } catch (err) {
      console.error(err);
    }
  });
}
if (uploadTemplateBtn){
  uploadTemplateBtn.addEventListener('click', async () => {
    const file = templateUploadInput?.files?.[0];
    if (!file){
      if (templateStatus) templateStatus.textContent = "請選擇要上傳的模板檔案";
      return;
    }
    const fd = new FormData();
    fd.append("template_file", file);
    try {
      await loadTemplateFromServer(fd);
      if (existingTemplateSelect && templateFile){
        if (!Array.from(existingTemplateSelect.options).some(o => o.value === templateFile)){
          const opt = document.createElement("option");
          opt.value = templateFile;
          opt.textContent = templateFile;
          existingTemplateSelect.appendChild(opt);
        }
        existingTemplateSelect.value = templateFile;
      }
    } catch (err) {
      console.error(err);
    } finally {
      if (templateUploadInput) templateUploadInput.value = "";
    }
  });
}
renderTemplatePreview();
refreshTemplateSelects();
function genId(){ return (Date.now().toString(36) + Math.random().toString(36).slice(2,7)); }
function updateOrder(){
  const cards = Array.from(document.querySelectorAll("#steps > .card"));
  const ids = cards.map(el => el.dataset.sid);
  document.getElementById("ordered_ids").value = ids.join(",");
  cards.forEach((card, index) => {
    const badge = card.querySelector(".step-index");
    if (badge) badge.textContent = index + 1;
  });
  markDirty();
}
const normalizePreset = (raw = {}) => {
  const preset = { ...raw };
  if (preset.use_chapter_title === undefined && preset.target_title !== undefined) {
    preset.use_chapter_title = preset.target_title;
  }
  if (!preset.target_chapter_title && preset.target_title_section) {
    preset.target_chapter_title = preset.target_title_section;
  }
  if (!preset.target_subtitle && preset.subheading_text) {
    preset.target_subtitle = preset.subheading_text;
  }
  if (!preset.target_caption_label) {
    preset.target_caption_label = preset.target_figure_label || preset.target_table_label || "";
  }
  if (preset.ignore_toc === undefined && preset.ignore_toc_and_before !== undefined) {
    preset.ignore_toc = preset.ignore_toc_and_before;
  }
  return preset;
};

function addStep(typeKey, rawPreset = {}, refSid=null, position='end'){
  const preset = normalizePreset(rawPreset || {});
  const spec = SUPPORTED_STEPS[typeKey];
  const sid = genId();
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.sid = sid;

  const menuBefore = buildInsertMenu(sid, 'before');
  const menuAfter = buildInsertMenu(sid, 'after');

  const isWordExtractStep = typeKey === "extract_word_chapter";

  const getValue = (key) => {
    const raw = preset[key];
    return raw === undefined || raw === null ? "" : String(raw);
  };

  const getBoolValue = (key) => {
    const raw = preset[key];
    return (raw === undefined || raw === null || raw === "") ? (BOOL_DEFAULTS[key] || "true") : String(raw);
  };

  const renderBoolToggle = (key, label, extraClass = "", colClass = "col-md-4") => {
    const boolVal = getBoolValue(key);
    const checked = boolVal !== "false" ? "checked" : "";
    const hiddenVal = boolVal !== "false" ? "true" : "false";
    const inputId = `step_${sid}_${key}_chk`;
    return `
      <div class="${colClass}">
        <div class="form-check">
          <input type="hidden" name="step_${sid}_${key}" value="${hiddenVal}">
          <input class="form-check-input bool-toggle${extraClass}" type="checkbox" id="${inputId}" data-target="step_${sid}_${key}" ${checked}>
          <label class="form-check-label" for="${inputId}">${label}</label>
        </div>
      </div>`;
  };

  if (isWordExtractStep){
    const fileVal = getValue("input_file");
    const fileAccept = spec.accepts["input_file"] || "file:docx";
    const fileExt = fileAccept.split(":")[1];
    const fileOptions = (AVAILABLE_FILES[fileExt] || []).map(f => `<option value="${f}" ${fileVal===f?"selected": ""}>${f}</option>`).join("");
    const filePlaceholder = fileExt === "dir" ? "選擇資料夾" : "選擇檔案";

    const sectionKey = spec.inputs.includes("target_section") ? "target_section" : "target_chapter_section";
    const sectionLabel = (FIELD_META[sectionKey] || {}).label || sectionKey;
    const sectionPlaceholder = (FIELD_META[sectionKey] || {}).placeholder || sectionLabel;
    const sectionVal = getValue(sectionKey);

    const titleKey = "target_chapter_title";
    const titleLabel = (FIELD_META[titleKey] || {}).label || titleKey;
    const titlePlaceholder = (FIELD_META[titleKey] || {}).placeholder || titleLabel;
    const titleVal = getValue(titleKey);

    const targetTitleVal = getBoolValue("use_chapter_title");
    const subheadingVal = getValue("target_subtitle");
    const subheadingLabel = (FIELD_META["target_subtitle"] || {}).label || "小標題";
    const subheadingPlaceholder = (FIELD_META["target_subtitle"] || {}).placeholder || subheadingLabel;
    const subheadingHideStyle = targetTitleVal === "false" ? "display: none;" : "";

    const explicitLabel = (FIELD_META["explicit_end_title"] || {}).label || "強制結束標題";
    const explicitPlaceholder = (FIELD_META["explicit_end_title"] || {}).placeholder || explicitLabel;
    const explicitVal = getValue("explicit_end_title");

    const tplIndexVal = getValue("template_index");
    const tplDisabled = templateParagraphs.length === 0 ? "disabled" : "";
    const tplModeVal = getValue("template_mode") || "insert_after";

    const ignoreTocLabel = (FIELD_META["ignore_toc"] || {}).label || "移除目錄";
    const ignoreHeaderLabel = (FIELD_META["ignore_header_footer"] || {}).label || "移除頁首頁尾";
    const strictLabel = (FIELD_META["subheading_strict_match"] || {}).label || "小標題精確比對";

    const collapseId = `collapse_${sid}`;
    let body = `
    <div class="card-header d-flex justify-content-between align-items-center py-2 bg-white">
      <div class="d-flex align-items-center step-toggle" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="true">
        <i class="bi bi-chevron-right me-2 text-muted small transition-icon"></i>
        <h2 class="h5 mb-0">
          <span class="badge bg-secondary me-2 step-index"></span>
          ${spec.label}
        </h2>
      </div>
      <div class="btn-group">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入上方</button>
          <ul class="dropdown-menu">${menuBefore}</ul>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入下方</button>
          <ul class="dropdown-menu">${menuAfter}</ul>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp('${sid}')">上移</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown('${sid}')">下移</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${sid}')">刪除</button>
      </div>
    </div>
    <div id="${collapseId}" class="collapse show step-content">
      <div class="card-body">
        <input type="hidden" name="step_${sid}_type" value="${typeKey}">

        <div class="mt-3">
          <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
            <i class="bi bi-diagram-3"></i>
            來源與章節設定
          </div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">輸入檔案</label>
              <select class="form-select" name="step_${sid}_input_file" required>
                <option value="" disabled ${fileVal ? "" : "selected"}>${filePlaceholder}</option>
                ${fileOptions}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">${sectionLabel}</label>
              <input class="form-control" name="step_${sid}_${sectionKey}" value="${sectionVal}" placeholder="${sectionPlaceholder}">
            </div>
            <div class="col-md-6">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>${titleLabel}</span>
                <span class="form-check d-flex align-items-center gap-1 m-0">
                  <input type="hidden" name="step_${sid}_use_chapter_title" value="${targetTitleVal !== "false" ? "true" : "false"}">
                  <input class="form-check-input bool-toggle toggle-subheading" type="checkbox" data-target="step_${sid}_use_chapter_title" ${targetTitleVal !== "false" ? "checked" : ""}>
                  <span class="small text-muted">擷取小標題內容</span>
                </span>
              </label>
              <input class="form-control" name="step_${sid}_target_chapter_title" value="${titleVal}" placeholder="${titlePlaceholder}">
            </div>
          </div>

          <div class="card bg-light border mt-3 subheading-input" style="${subheadingHideStyle}">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
                <i class="bi bi-card-text"></i>
                指定擷取的小標題
              </div>
              <input class="form-control" name="step_${sid}_target_subtitle" value="${subheadingVal}" placeholder="${subheadingPlaceholder}">
              <div class="form-text">提示：啟用此功能後，系統將僅針對該標題下的小標題進行內容擷取。</div>
            </div>
          </div>

          <div class="card bg-light border mt-3">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
                <i class="bi bi-list-check"></i>
                擷取規則
              </div>
              <div class="row g-2">
                ${spec.inputs.includes("subheading_strict_match") ? renderBoolToggle("subheading_strict_match", strictLabel, "", "col-md-4") : ""}
                ${spec.inputs.includes("ignore_toc") ? renderBoolToggle("ignore_toc", ignoreTocLabel, "", "col-md-4") : ""}
                ${spec.inputs.includes("ignore_header_footer") ? renderBoolToggle("ignore_header_footer", ignoreHeaderLabel, "", "col-md-4") : ""}
              </div>
            </div>
          </div>

        </div>

        <div class="mt-4">
          <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
            <i class="bi bi-box-arrow-in-down"></i>
            輸出與插入設定
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">模板段落</label>
              <select class="form-select" name="step_${sid}_template_index" data-template-select="1" ${tplDisabled}>
                ${buildTemplateOptions(tplIndexVal)}
              </select>
              <div class="form-text">${templateParagraphs.length ? "選擇要插入的位置（段落 index）" : "請先解析模板"}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">插入方式</label>
              <select class="form-select" name="step_${sid}_template_mode">
                <option value="insert_after" ${tplModeVal==="insert_after"?"selected": ""}>段落後新增</option>
                <option value="replace" ${tplModeVal==="replace"?"selected": ""}>取代該段落</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>`;

    card.innerHTML = body;
    const container = document.getElementById("steps");
    if (refSid){
      const ref = document.querySelector(`.card[data-sid="${refSid}"]`);
      if (ref){
        if (position === 'before'){
          container.insertBefore(card, ref);
        } else {
          container.insertBefore(card, ref.nextSibling);
        }
      } else {
        container.appendChild(card);
      }
    } else {
      container.appendChild(card);
    }
    card.querySelectorAll(".bool-toggle").forEach(toggle => {
      toggle.addEventListener("change", () => {
        const target = toggle.dataset.target;
        const hidden = card.querySelector(`input[type="hidden"][name="${target}"]`);
        if (hidden) hidden.value = toggle.checked ? "true" : "false";
      });
    });
    const subheadingToggle = card.querySelector(".toggle-subheading");
    const subheadingInput = card.querySelector(".subheading-input");
    if (subheadingToggle && subheadingInput) {
      subheadingToggle.addEventListener("change", () => {
        subheadingInput.style.display = subheadingToggle.checked ? "" : "none";
      });
    }
    refreshTemplateSelects();
    updateOrder();
    return;
  }

  const targetTitleRaw = preset["use_chapter_title"];
  const targetTitleVal = (targetTitleRaw === undefined || targetTitleRaw === null || targetTitleRaw === "")
    ? (BOOL_DEFAULTS["use_chapter_title"] || "false")
    : String(targetTitleRaw);

  const templateKeys = new Set(["template_index", "template_mode"]);
  const basicFields = [];
  const ruleFields = [];
  const templateFields = [];

  const subtitleToggleSteps = ["extract_specific_figure_from_word", "extract_specific_table_from_word"];
      const renderField = (k) => {
    const accept = spec.accepts[k];
    const meta = FIELD_META[k] || {};
    const label = meta.label || k;
    const placeholder = meta.placeholder || label;
    const rawVal = preset[k];
    const val = rawVal === undefined || rawVal === null ? "" : String(rawVal);

    if (k === "input_file" && subtitleToggleSteps.includes(typeKey)) {
      const acceptFile = spec.accepts[k] || "file:docx";
      const ext = acceptFile.split(":")[1];
      const options = (AVAILABLE_FILES[ext] || []).map(f => `<option value="${f}" ${val===f?"selected": ""}>${f}</option>`).join("");
      const filePlaceholder = ext === "dir" ? "選擇資料夾" : "選擇檔案";
      const selected = val ? "" : "selected";
      return `<div class="col-12"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}" required>
                 <option value="" disabled ${selected}>${filePlaceholder}</option>${options}
               </select></div>`;
    }

    if (k === "template_index"){
      const disabled = templateParagraphs.length === 0 ? "disabled" : "";
      return `<div class="col-md-6"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_template_index" data-template-select="1" ${disabled}>
                 ${buildTemplateOptions(val)}
               </select>
               <div class="form-text">${templateParagraphs.length ? "選擇要插入的位置（段落 index）" : "請先解析模板"}</div>
             </div>`;
    }
    if (k === "template_mode") {
      const modeVal = val || "insert_after";
      return `<div class="col-md-3"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_template_mode">
                 <option value="insert_after" ${modeVal==="insert_after"?"selected": ""}>段落後新增</option>
                 <option value="replace" ${modeVal==="replace"?"selected": ""}>取代該段落</option>
               </select></div>`;
    }
    if (accept === "text"){
      if (k === "target_subtitle") {
        const hideStyle = (spec.inputs.includes("use_chapter_title") && targetTitleVal === "false") ? "display: none;" : "";
        return `<div class="col-md-9 subheading-input" style="${hideStyle}"><label class="form-label">${label}</label>
                 <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
      }
      if (k === "target_section" || k === "target_chapter_section") {
        return `<div class="col-md-6"><label class="form-label">${label}</label>
                 <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
      }
      if (k === "target_subtitle" && subtitleToggleSteps.includes(typeKey)) {
          return `<div class="col-12 subtitle-wrap mt-3">
                    <div class="card bg-light border">
                      <div class="card-body">
                        <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
                          <i class="bi bi-card-text"></i>
                          指定擷取的小標題
                        </div>
                        <input class="form-control subtitle-input" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}">
                        <div class="form-text">提示：啟用此功能後，系統將僅針對該標題下的小標題進行內容擷取。</div>
                      </div>
                    </div>
                  </div>`;
        }
        if (k === "target_caption_label" && subtitleToggleSteps.includes(typeKey)) {
          return `<div class="col-md-5"><label class="form-label">${label}</label>
                   <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
        }
        return `<div class="col-md-6"><label class="form-label">${label}</label>
                 <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
      }
    if (accept === "bool"){
      const boolDefault = BOOL_DEFAULTS[k] || "true";
      const boolVal = val === "" ? boolDefault : val;
      if (k === "ignore_toc" || k === "ignore_header_footer" || k === "use_chapter_title" || k === "subheading_strict_match" || k === "include_caption" || k === "bold" || k === "page_break_before"){
        const checked = boolVal !== "false" ? "checked" : "";
        const hiddenVal = boolVal !== "false" ? "true" : "false";
        const inputId = `step_${sid}_${k}_chk`;
        const extraClass = k === "use_chapter_title" ? " toggle-subheading" : "";
        const colClass = k === "subheading_strict_match" ? "col-md-12" : "col-md-3";
        return `<div class="${colClass}">
                 <div class="form-check">
                   <input type="hidden" name="step_${sid}_${k}" value="${hiddenVal}">
                   <input class="form-check-input bool-toggle${extraClass}" type="checkbox" id="${inputId}" data-target="step_${sid}_${k}" ${checked}>
                   <label class="form-check-label" for="${inputId}">${label}</label>
                 </div>
               </div>`;
      }
      return `<div class="col-md-3"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}">
                 <option value="false" ${boolVal==="false"?"selected": ""}>否</option>
                 <option value="true" ${boolVal!=="false"?"selected": ""}>是</option>
               </select>
             </div>`;
    }
    if (accept === "int" || accept === "float"){
      if (k === "level") {
        let options = "", help = "";
        if (typeKey === "insert_numbered_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（1.）</option>
                     <option value="1" ${val==="1"?"selected": ""}>Level 1（1.1.）</option>
                     <option value="2" ${val==="2"?"selected": ""}>Level 2（1.1.1.）</option>`;
          help = "建議僅用到 Level 2；更深層需先擴充樣式。";
        } else if (typeKey === "insert_roman_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（I.）</option>`;
          help = "僅定義 Level 0；要 I→A→1 多層需擴充樣式。";
        } else {
          options = `<option value="0" ${val==="0"?"selected": ""}>0</option>`;
        }
        return `<div class="col-md-4">
                 <label class="form-label">level</label>
                 <select class="form-select" name="step_${sid}_${k}">${options}</select>
                 <div class="form-text">${help}</div>
               </div>`;
      }
      if (k === "font_size") {
        return `<div class="col-md-3"><label class="form-label">字體大小</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="12" ${val==="12"?"selected": ""}>12</option>
                   <option value="13" ${val==="13"?"selected": ""}>13</option>
                   <option value="14" ${val==="14"?"selected": ""}>14</option>
                   <option value="16" ${val==="16"?"selected": ""}>16</option>
                   <option value="18" ${val==="18"?"selected": ""}>18</option>
                 </select></div>`;
      }
      if (k === "before_space" || k === "after_space") {
        const nice = k === "before_space" ? "段前間距" : "段後間距";
        return `<div class="col-md-3"><label class="form-label">${nice}</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="0" ${val==="0"?"selected": ""}>0 pt</option>
                   <option value="6" ${val==="6"?"selected": ""}>6 pt</option>
                   <option value="12" ${val==="12"?"selected": ""}>12 pt</option>
                 </select></div>`;
      }
      return `<div class="col-md-3"><label class="form-label">${label}</label>
               <input class="form-control" type="number" step="any" name="step_${sid}_${k}" value="${val}" placeholder="${placeholder}"></div>`;
    }
    if (accept.startsWith("file")){
      const ext = accept.split(":")[1];
      const options = (AVAILABLE_FILES[ext] || []).map(f => `<option value="${f}" ${val===f?"selected": ""}>${f}</option>`).join("");
      const filePlaceholder = ext === "dir" ? "選擇資料夾" : "選擇檔案";
      const selected = val ? "" : "selected";
      return `<div class="col-md-6"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}" required>
                 <option value="" disabled ${selected}>${filePlaceholder}</option>${options}
               </select></div>`;
    }
    if (k === "align"){
      return `<div class="col-md-3"><label class="form-label">對齊</label>
               <select class="form-select" name="step_${sid}_align">
                 <option value="left" ${val==="left"?"selected": ""}>靠左</option>
                 <option value="center" ${val==="center"?"selected": ""}>置中</option>
                 <option value="right" ${val==="right"?"selected": ""}>靠右</option>
                 <option value="justify" ${val==="justify"?"selected": ""}>左右對齊</option>
               </select>
             </div>`;
    }
    return "";
  };

  const subtitleFields = [];
  const handledKeys = new Set();

  if (subtitleToggleSteps.includes(typeKey)) {
    if (spec.inputs.includes("input_file")) {
      basicFields.push(renderField("input_file"));
      handledKeys.add("input_file");
    }
    if (spec.inputs.includes("target_chapter_section")) {
      const targetKey = "target_caption_label";
      const targetMeta = FIELD_META[targetKey] || {};
      const targetLabel = targetMeta.label || targetKey;
      const targetPlaceholder = targetMeta.placeholder || targetLabel;
      const targetRaw = preset[targetKey];
      const targetVal = targetRaw === undefined || targetRaw === null ? "" : String(targetRaw);
      const sectionVal = getValue("target_chapter_section");
      basicFields.push(`
        <div class="col-md-6">
          <label class="form-label">${FIELD_META.target_chapter_section?.label || "章節編號"}</label>
          <input class="form-control" name="step_${sid}_target_chapter_section" value="${sectionVal}" placeholder="${FIELD_META.target_chapter_section?.placeholder || "例如 6.12.1"}">
        </div>
        <div class="col-md-6">
          <label class="form-label">${targetLabel}</label>
          <input class="form-control" name="step_${sid}_${targetKey}" value="${targetVal}" placeholder="${targetPlaceholder}">
        </div>
      `);
      handledKeys.add("target_chapter_section");
      handledKeys.add(targetKey);
    }
  }

  for (const k of spec.inputs){
    if (handledKeys.has(k)) {
      continue;
    }
    if (templateKeys.has(k)) {
      templateFields.push(renderField(k));
      continue;
    }
    const accept = spec.accepts[k];
    if (accept === "bool") {
      ruleFields.push(renderField(k));
      continue;
    }
    if (k === "target_subtitle" && subtitleToggleSteps.includes(typeKey)) {
      subtitleFields.push(renderField(k));
    } else {
      basicFields.push(renderField(k));
    }
  }

  const collapseId = `collapse_${sid}`;
  let body = `
    <div class="card-header d-flex justify-content-between align-items-center py-2 bg-white">
      <div class="d-flex align-items-center step-toggle" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="true">
        <i class="bi bi-chevron-right me-2 text-muted small transition-icon"></i>
        <h2 class="h5 mb-0">
          <span class="badge bg-secondary me-2 step-index"></span>
          ${spec.label}
        </h2>
      </div>
      <div class="btn-group">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入上方</button>
          <ul class="dropdown-menu">${menuBefore}</ul>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入下方</button>
          <ul class="dropdown-menu">${menuAfter}</ul>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp('${sid}')">上移</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown('${sid}')">下移</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${sid}')">刪除</button>
      </div>
    </div>
    <div id="${collapseId}" class="collapse show step-content">
      <div class="card-body">
        <input type="hidden" name="step_${sid}_type" value="${typeKey}">

        ${basicFields.length ? `
        <div class="card bg-light border mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
              <i class="bi bi-gear"></i>
              基本設定
            </div>
            <div class="row g-3">${basicFields.join("")}</div>
          </div>
        </div>` : ""}

        ${subtitleFields.length ? subtitleFields.join("") : ""}

        ${ruleFields.length ? `
        <div class="card bg-light border mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
              <i class="bi bi-list-check"></i>
              選項與規則
            </div>
            <div class="row g-3">${ruleFields.join("")}</div>
          </div>
        </div>` : ""}

        ${templateFields.length ? `
        <div class="card bg-light border mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center gap-2 text-primary fw-semibold small mb-2">
              <i class="bi bi-box-arrow-in-down"></i>
              輸出與插入設定
            </div>
            <div class="row g-3">${templateFields.join("")}</div>
          </div>
        </div>` : ""}
      </div>
    </div>`;

  card.innerHTML = body;
  const container = document.getElementById("steps");
  if (refSid){
    const ref = document.querySelector(`.card[data-sid="${refSid}"]`);
    if (ref){
      if (position === 'before'){
        container.insertBefore(card, ref);
      } else {
        container.insertBefore(card, ref.nextSibling);
      }
    } else {
      container.appendChild(card);
    }
  } else {
    container.appendChild(card);
  }
  card.querySelectorAll(".bool-toggle").forEach(toggle => {
    toggle.addEventListener("change", () => {
      const target = toggle.dataset.target;
      const hidden = card.querySelector(`input[type="hidden"][name="${target}"]`);
      if (hidden) hidden.value = toggle.checked ? "true" : "false";
    });
  });
  const subheadingToggle = card.querySelector(".toggle-subheading");
  const subheadingInput = card.querySelector(".subheading-input");
  if (subheadingToggle && subheadingInput) {
    subheadingToggle.addEventListener("change", () => {
      subheadingInput.style.display = subheadingToggle.checked ? "" : "none";
    });
  }
  refreshTemplateSelects();
  updateOrder();
}
function removeStep(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (el) el.remove();
  updateOrder();
}
function moveStep(sid, direction){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (!el) return;
  const sibling = direction === 'up' ? el.previousElementSibling : el.nextElementSibling;
  if (!sibling) return;
  if (direction === 'up') {
    el.parentNode.insertBefore(el, sibling);
  } else {
    el.parentNode.insertBefore(sibling, el);
  }
  updateOrder();
}
function moveUp(sid){ moveStep(sid, 'up'); }
function moveDown(sid){ moveStep(sid, 'down'); }
function renameFlow(current){
  const name = prompt('輸入新流程名稱', current);
  if(!name) return;
  submitPostForm(`/tasks/${TASK_ID}/flows/rename/${current}`, { name });
}
if (PRESET_FLOW){
  for (const st of PRESET_FLOW){
    addStep(st.type, st.params);
  }
}

const toggleAllStepsBtn = document.getElementById('toggleAllStepsBtn');
let allCollapsed = false;
if (toggleAllStepsBtn) {
  toggleAllStepsBtn.addEventListener('click', () => {
    const collapses = document.querySelectorAll('.step-content');
    allCollapsed = !allCollapsed;
    collapses.forEach(el => {
      const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el);
      if (allCollapsed) bsCollapse.hide();
      else bsCollapse.show();
    });
    toggleAllStepsBtn.innerHTML = allCollapsed ? '<i class="bi bi-arrows-expand"></i> 全部展開' : '<i class="bi bi-arrows-collapse"></i> 全部收合';
  });
}

isInitialising = false;
</script>

{% endblock %}
