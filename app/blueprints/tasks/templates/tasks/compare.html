{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">來源比對</h1>
<div class="row g-3">
  <div class="col-md-8">
    <iframe id="htmlFrame" src="{{ html_url }}" style="width:100%; height:80vh;" class="border"></iframe>
  </div>
  <div class="col-md-4">
    <ul id="sourceList" class="list-group"></ul>
    <div class="mt-3">
      <div class="d-flex gap-2">
        <button id="modeBtn" class="btn btn-outline-secondary" type="button">編輯模式</button>
        <button id="saveBtn" class="btn btn-primary" type="button">保存</button>
        <button id="saveAsBtn" class="btn btn-outline-primary" type="button">另存新檔</button>
        <button id="downloadBtn" class="btn btn-success" type="button">下載</button>
        <a class="btn btn-secondary" href="{{ back_link }}">返回結果</a>
      </div>
      <span id="saveStatus" class="d-block mt-2">已保存</span>
    </div>
    <div class="mt-4">
      <h2 class="h6 mb-2">版本歷程</h2>
      <ul id="versionList" class="list-group small">
        {% if versions %}
          {% for version in versions %}
            <li class="list-group-item d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div>
                <div class="fw-semibold">{{ version.name }}</div>
                <div class="text-muted">{{ version.created_at_display }}</div>
              </div>
              <div class="btn-group btn-group-sm flex-wrap">
                <a class="btn btn-outline-secondary" href="{{ version.html_url }}" target="_blank">檢視</a>
                <a class="btn btn-outline-success" href="{{ version.docx_url }}">下載</a>
                <button class="btn btn-outline-primary restore-version" data-restore-url="{{ version.restore_url }}" data-version-name="{{ version.name }}">恢復</button>
                <button class="btn btn-outline-danger delete-version" data-delete-url="{{ version.delete_url }}" data-version-name="{{ version.name }}">刪除</button>
              </div>
            </li>
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted" data-placeholder="empty">尚無版本紀錄</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<div class="modal fade" id="sourceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">來源檔案預覽</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0"></div>
    </div>
  </div>
</div>
<script>
const CHAPTER_SOURCES = {{ chapter_sources|tojson }};
const CHAPTERS = {{ chapters|tojson }};
const SOURCE_URLS = {{ source_urls|tojson }};
const TITLES_TO_HIDE = {{ titles_to_hide|tojson }};
const SAVE_AS_URL = '{{ save_as_url }}';
const COLORS = ['#ffb3ba','#baffc9','#bae1ff','#ffdfba','#ffffba','#baffff','#f4baff'];
const CHAPTER_SET = new Set(CHAPTERS);
let highlighted = [];
let hiddenTitleNodes = [];

function openWindow(url) {
  window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

function formatVersionName(name) {
  return name || '未命名';
}

async function postJson(url, options = {}) {
  const resp = await fetch(url, Object.assign({method: 'POST'}, options));
  let data = null;
  try {
    data = await resp.json();
  } catch (err) {
    data = null;
  }
  return {resp, data};
}

function clearHighlights() {
  highlighted.forEach(el => {
    el.style.backgroundColor = '';
  });
  highlighted = [];
}

function updateSources(ch, element) {
  clearHighlights();
  const list = document.getElementById('sourceList');
  list.innerHTML = '';
  let sequence = [];
  if (Array.isArray(ch)) {
    sequence = ch.slice();
  } else if (ch === null) {
    const all = Object.values(CHAPTER_SOURCES).flat();
    sequence = all.slice();
  } else {
    sequence = CHAPTER_SOURCES[ch] || [];
  }
  if (!sequence.length) return;

  const uniqueSources = [...new Set(sequence)];
  const colorMap = {};
  let colorIdx = 0;
  let pdfColor = null;
  uniqueSources.forEach(src => {
    let color;
    if (src.toLowerCase().endsWith('.pdf')) {
      if (!pdfColor) {
        pdfColor = COLORS[colorIdx % COLORS.length];
        colorIdx++;
      }
      color = pdfColor;
    } else {
      color = COLORS[colorIdx % COLORS.length];
      colorIdx++;
    }
    colorMap[src] = color;
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = src;
    li.style.backgroundColor = color;
    const url = SOURCE_URLS[src];
    if (url) {
      li.style.cursor = 'pointer';
      li.addEventListener('click', () => openWindow(url));
    }
    list.appendChild(li);
  });

  if (element) {
    let node = element.nextElementSibling;
    let idx = 0;
    const markers = sequence.map(src => {
      const title = src.match(/標題\s*(.+)/);
      if (title) return {type: 'title', value: title[1]};
      const sec = src.match(/章節\s*([\d\.]+)/);
      return sec ? {type: 'section', value: sec[1]} : null;
    });
    const findNextMarkerIdx = from => {
      for (let i = from + 1; i < markers.length; i++) {
        if (markers[i]) return i;
      }
      return -1;
    };
    let nextIdx = findNextMarkerIdx(0);
    let nextMarker = nextIdx !== -1 ? markers[nextIdx] : null;
    while (node && !CHAPTER_SET.has(node.textContent.trim())) {
      const text = node.textContent.trim();
      if (nextMarker && highlighted.length && (
          (nextMarker.type === 'section' && text.startsWith(nextMarker.value)) ||
          (nextMarker.type === 'title' && text.includes(nextMarker.value))
        )) {
        idx = nextIdx;
        nextIdx = findNextMarkerIdx(idx);
        nextMarker = nextIdx !== -1 ? markers[nextIdx] : null;
      }
        const src = sequence[idx] || sequence[sequence.length - 1];
        node.style.backgroundColor = colorMap[src];
        highlighted.push(node);
        node = node.nextElementSibling;
      }
    }
  }

const iframe = document.getElementById('htmlFrame');
let doc;
let isSaved = true;
const statusEl = document.getElementById('saveStatus');
function setSaved(saved) {
  isSaved = saved;
  statusEl.textContent = saved ? '已保存' : '未保存';
  statusEl.classList.toggle('text-success', saved);
  statusEl.classList.toggle('text-danger', !saved);
}

function ensureVersionPlaceholder() {
  const list = document.getElementById('versionList');
  if (!list) return;
  const remaining = list.querySelectorAll('li:not([data-placeholder="empty"])');
  if (remaining.length === 0) {
    let placeholder = list.querySelector('[data-placeholder="empty"]');
    if (!placeholder) {
      placeholder = document.createElement('li');
      placeholder.className = 'list-group-item text-muted';
      placeholder.dataset.placeholder = 'empty';
      placeholder.textContent = '尚無版本紀錄';
      list.appendChild(placeholder);
    }
  }
}

function hideChapterTitles() {
  hiddenTitleNodes = [];
  if (!doc || !doc.body) return;
  const titles = Array.isArray(TITLES_TO_HIDE) ? TITLES_TO_HIDE : [];
  const trimmed = titles.map(t => (t || '').trim()).filter(Boolean);
  if (!trimmed.length) return;
  const hideSet = new Set(trimmed);
  const paragraphs = doc.body.querySelectorAll('p');
  paragraphs.forEach(p => {
    const text = p.textContent.trim();
    if (hideSet.has(text)) {
      if (!p.dataset.prevDisplay) {
        p.dataset.prevDisplay = p.style.display || '';
      }
      p.style.display = 'none';
      hiddenTitleNodes.push(p);
    }
  });
}
setSaved(true);

iframe.addEventListener('load', () => {
  doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.designMode = 'off';
  doc.addEventListener('input', () => setSaved(false));
  hideChapterTitles();
  let found = false;
  let unhandled = [];
  CHAPTERS.forEach(ch => {
    const elements = Array.from(doc.body.querySelectorAll('*')).filter(el => el.textContent.trim() === ch);
    if (elements.length) {
      found = true;
      elements.forEach(el => {
        el.style.cursor = 'pointer';
        el.addEventListener('click', () => updateSources(ch, el));
      });
    } else {
      unhandled = unhandled.concat(CHAPTER_SOURCES[ch] || []);
    }
  });
  if (unhandled.length) {
    updateSources(unhandled);
  } else if (!found) {
    updateSources(null);
  }
});

document.getElementById('modeBtn').addEventListener('click', () => {
  if (!doc) return;
  if (doc.designMode === 'on') {
    doc.designMode = 'off';
    document.getElementById('modeBtn').textContent = '編輯模式';
  } else {
    doc.designMode = 'on';
    document.getElementById('modeBtn').textContent = '檢視模式';
  }
});

function saveHtml(targetUrl = '{{ save_url }}', extraData = {}) {
  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
  hiddenTitleNodes.forEach(node => {
    node.style.display = node.dataset.prevDisplay || '';
  });
  const html = iframeDoc.documentElement.outerHTML;
  hiddenTitleNodes.forEach(node => {
    node.style.display = 'none';
  });
  const payload = Object.assign({html}, extraData);
  return fetch(targetUrl, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
}

document.getElementById('saveBtn').addEventListener('click', () => {
  saveHtml().then(r => {
    if (r.ok) {
      setSaved(true);
      alert('已保存');
    } else {
      alert('保存失敗');
    }
  });
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  if (!isSaved) {
    alert('請先保存才可下載');
    return;
  }
  window.location = '{{ download_url }}';
});

function attachRestoreHandler(btn) {
  if (!btn) return;
  btn.addEventListener('click', async () => {
    const url = btn.dataset.restoreUrl;
    if (!url) return;
    const name = btn.dataset.versionName || '';
    const displayName = formatVersionName(name);
    const message = isSaved
      ? `確定要恢復版本「${displayName}」嗎？目前內容將被覆蓋。`
      : `目前有未保存的變更，確定要恢復版本「${displayName}」並覆蓋現有內容嗎？`;
    if (!confirm(message)) {
      return;
    }
    try {
      const {resp, data} = await postJson(url);
      if (!resp.ok) {
        const errorMessage = data && data.error ? data.error : '恢復版本失敗';
        alert(errorMessage);
        return;
      }
      setSaved(true);
      try {
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.location.reload();
        }
      } catch (err) {
        iframe.src = iframe.src;
      }
      alert('已恢復指定版本');
      window.location.reload();
    } catch (err) {
      alert('恢復版本失敗');
    }
  });
}

function attachDeleteHandler(btn) {
  if (!btn) return;
  btn.addEventListener('click', async () => {
    const url = btn.dataset.deleteUrl;
    if (!url) return;
    const name = btn.dataset.versionName || '';
    const displayName = formatVersionName(name);
    const message = `確定要刪除版本「${displayName}」嗎？此操作無法復原。`;
    if (!confirm(message)) {
      return;
    }
    try {
      const {resp, data} = await postJson(url);
      if (!resp.ok) {
        const errorMessage = data && data.error ? data.error : '刪除版本失敗';
        alert(errorMessage);
        return;
      }
      const item = btn.closest('li');
      if (item) {
        item.remove();
      }
      ensureVersionPlaceholder();
      alert('已刪除指定版本');
    } catch (err) {
      alert('刪除版本失敗');
    }
  });
}

function addVersionToList(version) {
  if (!version) return;
  const list = document.getElementById('versionList');
  if (!list) return;
  const placeholder = list.querySelector('[data-placeholder="empty"]');
  if (placeholder) {
    placeholder.remove();
  }
  const item = document.createElement('li');
  item.className = 'list-group-item d-flex justify-content-between align-items-start flex-wrap gap-2';
  const infoDiv = document.createElement('div');
  const nameDiv = document.createElement('div');
  nameDiv.className = 'fw-semibold';
  nameDiv.textContent = version.name || version.id || '未命名';
  const timeDiv = document.createElement('div');
  timeDiv.className = 'text-muted';
  timeDiv.textContent = version.created_at_display || '';
  infoDiv.appendChild(nameDiv);
  infoDiv.appendChild(timeDiv);
  const btnGroup = document.createElement('div');
  btnGroup.className = 'btn-group btn-group-sm flex-wrap';
  if (version.html_url) {
    const viewLink = document.createElement('a');
    viewLink.className = 'btn btn-outline-secondary';
    viewLink.href = version.html_url;
    viewLink.target = '_blank';
    viewLink.textContent = '檢視';
    btnGroup.appendChild(viewLink);
  }
  if (version.docx_url) {
    const downloadLink = document.createElement('a');
    downloadLink.className = 'btn btn-outline-success';
    downloadLink.href = version.docx_url;
    downloadLink.textContent = '下載';
    btnGroup.appendChild(downloadLink);
  }
  if (version.restore_url) {
    const restoreBtn = document.createElement('button');
    restoreBtn.className = 'btn btn-outline-primary restore-version';
    restoreBtn.dataset.restoreUrl = version.restore_url;
    restoreBtn.dataset.versionName = version.name || version.id || '';
    restoreBtn.type = 'button';
    restoreBtn.textContent = '恢復';
    btnGroup.appendChild(restoreBtn);
    attachRestoreHandler(restoreBtn);
  }
  if (version.delete_url) {
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-outline-danger delete-version';
    deleteBtn.dataset.deleteUrl = version.delete_url;
    deleteBtn.dataset.versionName = version.name || version.id || '';
    deleteBtn.type = 'button';
    deleteBtn.textContent = '刪除';
    btnGroup.appendChild(deleteBtn);
    attachDeleteHandler(deleteBtn);
  }
  item.appendChild(infoDiv);
  item.appendChild(btnGroup);
  list.prepend(item);
}

document.querySelectorAll('.restore-version').forEach(attachRestoreHandler);
document.querySelectorAll('.delete-version').forEach(attachDeleteHandler);

const saveAsBtn = document.getElementById('saveAsBtn');
if (saveAsBtn) {
  saveAsBtn.addEventListener('click', () => {
    const defaultName = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const input = prompt('請輸入版本名稱', defaultName);
    if (input === null) {
      return;
    }
    const name = input.trim();
    if (!name) {
      alert('版本名稱不可為空');
      return;
    }
    saveHtml(SAVE_AS_URL, {name}).then(async r => {
      let data = null;
      try {
        data = await r.json();
      } catch (err) {
        data = null;
      }
      if (!r.ok) {
        const message = data && data.error ? data.error : '另存新檔失敗';
        alert(message);
        return;
      }
      if (data && data.version) {
        addVersionToList(data.version);
      }
      alert('已另存為新版本');
    }).catch(() => {
      alert('另存新檔失敗');
    });
  });
}
</script>
{% endblock %}
