{# Flask-Admin helpers #}
{% import 'admin/layout.html' as layout with context -%}
{% import 'admin/static.html' as admin_static with context %}

<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <title>
      {% block title %}
        {% if admin_view.category %}{{ admin_view.category }} - {% endif %}
        {{ admin_view.name }} - {{ admin_view.admin.name }}
      {% endblock %}
    </title>

    {% block head_meta %}
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="description" content="">
      <meta name="author" content="">
    {% endblock %}

    {% block head_css %}
      {# 1. Bootstrap (Flask-Admin / Bootswatch) - 基底樣式 #}
      <link
        href="{{ admin_static.url(filename='bootstrap/bootstrap4/swatch/{swatch}/bootstrap.min.css'.format(swatch=theme.swatch), v='4.2.1') }}"
        rel="stylesheet" {{ admin_csp_nonce_attribute }}
      >
      {% if theme.swatch == 'default' %}
        <link
          href="{{ admin_static.url(filename='bootstrap/bootstrap4/css/bootstrap.min.css', v='4.2.1') }}"
          rel="stylesheet" {{ admin_csp_nonce_attribute }}
        >
      {% endif %}

      {# 2. AdminLTE - 版型與 sidebar/navbar 視覺（建立於 Bootstrap 4 之上） #}
      <link href="{{ url_for('static', filename='vendor/adminlte/adminlte.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='vendor/fontawesome/css/v4-shims.min.css') }}" rel="stylesheet">

      {# 3. Flask-Admin 補充樣式（表格/表單/欄位等） #}
      <link
        href="{{ admin_static.url(filename='admin/css/bootstrap4/admin.css', v='1.1.1') }}"
        rel="stylesheet" {{ admin_csp_nonce_attribute }}
      >

      {# 5. Scoped overrides：只修 sidebar 區域，避免影響 content 內的 dropdown #}
      <style>
        /* Sidebar link colors */
        .main-sidebar .nav-link {
          color: rgba(255, 255, 255, 0.85);
        }
        .main-sidebar .nav-link:hover,
        .main-sidebar .nav-link:focus,
        .main-sidebar .active > .nav-link {
          color: #fff;
          background: rgba(255, 255, 255, 0.12);
        }

        /*
          讓 Flask-Admin 的 layout.menu() 產生的 dropdown 結構
          在 AdminLTE sidebar 內以「樹狀」方式呈現：
          - 不使用 Bootstrap dropdown 的 absolute menu
          - 改為 sidebar 內展開
        */
        .main-sidebar .dropdown-menu {
          position: static;
          float: none;
          background: transparent;
          border: 0;
          padding: 4px 0 0 16px;
          margin: 0;
          display: none; /* 預設收合，透過 JS 切換顯示 */
        }
        .main-sidebar .dropdown.show > .dropdown-menu,
        .main-sidebar .dropdown.menu-open > .dropdown-menu {
          display: block;
        }

        .main-sidebar .dropdown-item {
          color: rgba(255, 255, 255, 0.85);
          padding: 4px 8px;
          white-space: normal;
        }
        .main-sidebar .dropdown-item:hover,
        .main-sidebar .dropdown-item:focus,
        .main-sidebar .dropdown-item.active {
          color: #fff;
          background: rgba(255, 255, 255, 0.12);
        }

        /* Sidebar 中的 dropdown toggle icon（選配：讓使用者知道可展開） */
        .main-sidebar .dropdown-toggle::after {
          float: right;
          margin-top: 0.5rem;
        }
              .admin-user-pill {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 4px 10px;
          background: #0d6efd;
          color: #fff;
          border-radius: 999px;
          font-weight: 600;
        }
        .admin-user-pill i {
          font-size: 14px;
        }
      </style>

      {# 6. View 額外 CSS #}
      {% if admin_view.extra_css %}
        {% for css_url in admin_view.extra_css %}
          <link href="{{ css_url }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% endfor %}
      {% endif %}
    {% endblock %}

    {% block head %}{% endblock %}
    {% block head_tail %}{% endblock %}
  </head>

  <body class="hold-transition sidebar-mini">
    {% block page_body %}
      <div class="wrapper">

        {# Top Navbar #}
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                <i class="fas fa-bars"></i>
              </a>
            </li>
          </ul>

          {% block menu_links %}
          <ul class="navbar-nav ml-auto">
            {% if current_user and current_user.is_authenticated %}
              <li class="nav-item d-none d-sm-inline-block">
                                <span class="nav-link">
                  <span class="admin-user-pill">
                    <i class="fas fa-user-circle"></i>
                    {{ current_user.username }}
                  </span>
                </span>
              </li>
            {% endif %}
            {{ layout.menu_links() }}
          </ul>
          {% endblock %}

          {% block access_control %}{% endblock %}
        </nav>

        {# Sidebar #}
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
          {% block brand %}
            <a class="brand-link" href="{{ admin_view.admin.url }}">
              <span class="brand-text font-weight-light">{{ admin_view.admin.name }}</span>
            </a>
          {% endblock %}

          <div class="sidebar">
            {% block main_menu %}
              <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                                    <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('tasks_bp.tasks') }}">
                      <i class="fas fa-arrow-left nav-icon"></i>
                      <p>返回系統</p>
                    </a>
                  </li>
                  {{ layout.menu() }}
                </ul>
              </nav>
            {% endblock %}
          </div>
        </aside>

        {# Content #}
        <div class="content-wrapper">
          <section class="content pt-3">
            <div class="container-fluid">

              {% block messages %}
                {{ layout.messages() }}
              {% endblock %}

              {# store the jinja2 context for form_rules rendering logic #}
              {% set render_ctx = h.resolve_ctx() %}

              {% block body %}{% endblock %}
            </div>
          </section>
        </div>

      </div>
    {% endblock %}

    {% block tail_js %}
      {# JS 載入順序：jQuery -> Popper -> Bootstrap -> AdminLTE -> Plugins #}
      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='vendor/jquery.min.js', v='3.5.1') }}"
              type="text/javascript"></script>

      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/popper.min.js') }}"
              type="text/javascript"></script>

      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/bootstrap.min.js', v='4.2.1') }}"
              type="text/javascript"></script>

      <script src="{{ url_for('static', filename='vendor/adminlte/adminlte.min.js') }}"></script>

      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='vendor/moment.min.js', v='2.9.4') }}"
              type="text/javascript"></script>

      {# 重要：移除 util.js / dropdown.js，避免 dropdown plugin 重複載入造成衝突
         - bootstrap.min.js 已包含所需功能 #}
      {# <script src="{{ admin_static.url(filename='vendor/bootstrap4/util.js', v='4.3.1') }}"></script> #}
      {# <script src="{{ admin_static.url(filename='vendor/bootstrap4/dropdown.js', v='4.3.1') }}"></script> #}

      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='vendor/select2/select2.min.js', v='4.2.1') }}"
              type="text/javascript"></script>

      <script {{ admin_csp_nonce_attribute }}
              src="{{ admin_static.url(filename='admin/js/helpers.js', v='1.0.0') }}"
              type="text/javascript"></script>

      {# Sidebar dropdown 行為：只在 sidebar 內接管 dropdown toggle，避免與 Bootstrap dropdown 互相干擾 #}
      <script {{ admin_csp_nonce_attribute }} type="text/javascript">
        (function () {
          function isInSidebar(el) {
            return !!(el && el.closest && el.closest(".main-sidebar"));
          }

          document.addEventListener("click", function (e) {
            var link = e.target.closest ? e.target.closest("a") : null;
            if (!link) return;

            if (!isInSidebar(link)) return;

            var parentDropdown = link.closest(".dropdown");
            if (!parentDropdown) return;

            /*
              Flask-Admin menu 常見結構：
              <li class="dropdown">
                <a class="dropdown-toggle" href="...">...</a>
                <ul class="dropdown-menu">...</ul>
              </li>
              在 sidebar 中，我們把它當作 treeview 展開/收合。
            */
            var isToggle = link.classList.contains("dropdown-toggle") || link.getAttribute("data-toggle") === "dropdown";
            if (!isToggle) return;

            e.preventDefault();
            e.stopPropagation();

            // 同層只開一個（可維持 sidebar 整潔）
            var siblings = parentDropdown.parentElement ? parentDropdown.parentElement.querySelectorAll(":scope > .dropdown") : [];
            for (var i = 0; i < siblings.length; i++) {
              if (siblings[i] !== parentDropdown) {
                siblings[i].classList.remove("show");
                siblings[i].classList.remove("menu-open");
              }
            }

            // 切換目前
            parentDropdown.classList.toggle("show");
            parentDropdown.classList.toggle("menu-open");
          }, true);

          // 若當前頁面在子選單 active，進入頁面時自動展開父層
          document.addEventListener("DOMContentLoaded", function () {
            var activeItem = document.querySelector(".main-sidebar .dropdown-menu .active");
            if (!activeItem) return;
            var dropdown = activeItem.closest(".dropdown");
            if (!dropdown) return;
            dropdown.classList.add("show");
            dropdown.classList.add("menu-open");
          });
        })();
      </script>

      {% if admin_view.extra_js %}
        {% for js_url in admin_view.extra_js %}
          <script {{ admin_csp_nonce_attribute }} src="{{ js_url }}" type="text/javascript"></script>
        {% endfor %}
      {% endif %}
    {% endblock %}

    {% block tail %}{% endblock %}
  </body>
</html>
