{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">來源比對</h1>
<div class="row g-3">
  <div class="col-md-8">
    <iframe id="resultFrame" src="{{ html_url }}" style="width:100%; height:80vh;" class="border"></iframe>
  </div>
  <div class="col-md-4">
    <p class="form-label">點擊左側章節以查看來源</p>
    <ul id="sourceList" class="list-group"></ul>
    <div class="mt-3">
      <a class="btn btn-secondary" href="{{ back_link }}">返回結果</a>
    </div>
  </div>
</div>
<script>
const CHAPTER_SOURCES = {{ chapter_sources|tojson }};
function updateSources(ch){
  const list = document.getElementById('sourceList');
  list.innerHTML = '';
  (CHAPTER_SOURCES[ch] || []).forEach(src => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = src;
    list.appendChild(li);
  });
}
function normalize(text){
  return text.replace(/^\s*[IVXLCDM]+\.\s*/i, '').trim();
}
function setupFrame(){
  const frame = document.getElementById('resultFrame');
  const doc = frame.contentDocument;
  if(!doc) return;
  const map = {};
  Object.keys(CHAPTER_SOURCES).forEach(k => { map[normalize(k)] = k; });
  doc.querySelectorAll('p,h1,h2,h3,h4,h5,h6').forEach(el => {
    const key = map[normalize(el.innerText)];
    if(key){
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => updateSources(key));
    }
  });
}
document.getElementById('resultFrame').addEventListener('load', setupFrame);
</script>
{% endblock %}
