{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">來源比對</h1>
<div class="row g-3">
  <div class="col-md-8">
    <iframe src="{{ html_url }}" style="width:100%; height:80vh;" class="border"></iframe>
  </div>
  <div class="col-md-4">
    <p class="form-text">請點擊輸出內容中的章節標題以檢視來源</p>
    <ul id="sourceList" class="list-group"></ul>
    <div class="mt-3">
      <a class="btn btn-secondary" href="{{ back_link }}">返回結果</a>
    </div>
  </div>
</div>
<style>
.clickable-heading {
  text-decoration: underline;
  color: #0d6efd;
  cursor: pointer;
}
.clickable-heading:hover {
  color: #0a58ca;
}
</style>
<script>
const CHAPTER_SOURCES = {{ chapter_sources|tojson }};
function updateSources(ch){
  const list = document.getElementById('sourceList');
  list.innerHTML = '';
  (CHAPTER_SOURCES[ch] || []).forEach(src => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = src;
    list.appendChild(li);
  });
}
const firstChapter = Object.keys(CHAPTER_SOURCES)[0];
if (firstChapter) {
  updateSources(firstChapter);
}
const iframe = document.querySelector('iframe');
iframe.addEventListener('load', () => {
  const doc = iframe.contentDocument;
  const headings = doc.querySelectorAll('h1,h2,h3,h4,h5,h6,p');
  headings.forEach(h => {
    const text = h.textContent.replace(/\u00A0/g, ' ').trim();
    Object.keys(CHAPTER_SOURCES).forEach(ch => {
      const regex = new RegExp(`^${ch}\\b\\W*`);
      if (regex.test(text)) {
        h.classList.add('clickable-heading');
        h.setAttribute('title', '點擊以檢視來源');
        h.addEventListener('click', () => updateSources(ch));
      }
    });
  });
});
</script>
{% endblock %}
