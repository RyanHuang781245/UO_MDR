{% extends "base.html" %}
{% block content %}
{% macro render_tables(node, path="") %}
  {% if node.files %}
  <h6 class="mt-3">{{ path or '根目錄' }}</h6>
  <table class="table table-sm">
    <tbody>
      {% for fname in node.files %}
      <tr><td>{{ fname }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% for dname, dnode in node.dirs.items() %}
    {{ render_tables(dnode, path ~ ("/" if path else "") ~ dname) }}
  {% endfor %}
{% endmacro %}
<style>
  /* Allow this page to use the full viewport width so the canvas can stretch with the browser. */
  main.container {
    max-width: 100%;
  }

  .saved-flows-section {
    min-height: 400px;
  }

  .flow-manage-card .section-wrap {
    border: 1px solid #e9ecef;
    border-radius: 14px;
    padding: 1.25rem;
    background: #f8f9fa;
    height: 100%;
  }

  @media (min-width: 1200px) {
    .flow-manage-card .divider-xl {
      border-right: 1px solid #e9ecef;
    }
  }

  .flow-canvas-wrapper {
    position: relative;
    min-height: 900px;
    background: radial-gradient(#dee2e6 1px, transparent 1px);
    background-size: 24px 24px;
    overflow: hidden;
    border: 1px solid #dee2e6;
    border-radius: 12px;
  }

  #flow-canvas {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 900px;
    user-select: none;
    overflow: auto;
    cursor: grab;
  }

  #flow-canvas.panning {
    cursor: grabbing;
  }

  #canvas-content {
    position: relative;
    width: 100%;
    height: 100%;
    min-width: 2000px;
    min-height: 1300px;
    transform-origin: top left;
  }

  #connections-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .connection-line {
    fill: none;
    stroke: #6c757d;
    stroke-width: 4px;
    stroke-linecap: round;
    pointer-events: stroke;
    cursor: pointer;
    transition: stroke 0.2s;
  }

  .connection-line:hover { stroke: #dc3545; }

  .component-toggle {
    position: absolute;
    left: 12px;
    top: 12px;
    z-index: 6;
  }

  .hint-toggle {
    position: absolute;
    left: 50%;
    top: 12px;
    transform: translateX(-50%);
    z-index: 6;
  }

  .hint-panel {
    position: absolute;
    left: 50%;
    top: 64px;
    transform: translateX(-50%);
    max-width: 520px;
    z-index: 4;
  }

  .component-drawer {
    position: absolute;
    left: 12px;
    top: 56px;
    width: 240px;
    z-index: 5;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }

  .component-drawer.collapsed {
    transform: translateX(-260px);
    opacity: 0.25;
  }

  .component-item {
    cursor: grab;
  }

  .canvas-controls {
    position: absolute;
    right: 12px;
    top: 12px;
    z-index: 5;
  }

  .zoom-indicator {
    min-width: 72px;
  }

  .flow-node {
    position: absolute;
    width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    border: 1px solid #dee2e6;
    z-index: 10;
  }

  .flow-node .card-header {
    cursor: grab;
  }

  .port {
    width: 16px;
    height: 16px;
    background-color: #6c757d;
    border: 2px solid #fff;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    cursor: crosshair;
    z-index: 15;
    transition: transform 0.1s, background-color 0.1s;
  }

  .port:hover {
    transform: translateY(-50%) scale(1.1);
    background-color: #0d6efd;
  }

  .port.input { left: -10px; }
  .port.output { right: -10px; }

  .flow-node .form-control,
  .flow-node .form-select {
    font-size: 0.85rem;
  }

  .flow-node .form-text {
    font-size: 0.75rem;
  }
</style>

<h1 class="h3 mb-4">流程節點編輯器</h1>

<div class="row g-4">
  <div class="col-12">
    <div class="flow-canvas-wrapper" id="canvas-wrapper">
      <button type="button" class="btn btn-outline-secondary btn-sm component-toggle" id="toggle-drawer" onclick="toggleComponentDrawer()">
        隱藏元件庫
      </button>
      <button type="button" class="btn btn-outline-info btn-sm hint-toggle" id="toggle-hints" onclick="toggleHintPanel()">
        顯示操作提示
      </button>
      <div class="component-drawer">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">元件庫</div>
          <div class="card-body p-2">
            {% for key, meta in steps.items() %}
            <div class="card component-item mb-2" draggable="true" ondragstart="startDragComponent(event)" data-type="{{ key }}" data-label="{{ meta.label }}">
              <div class="card-body py-2 text-center fw-semibold">
                {{ meta.label }}
              </div>
            </div>
            {% endfor %}
            <div class="small text-muted px-2">拖曳元件到畫布建立節點，雙擊節點可開啟設定。</div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm hint-panel d-none" id="hint-panel">
        <div class="card-body p-3">
          <div class="fw-bold mb-2">操作提示</div>
          <ul class="small text-muted mb-2">
            <li>從左側元件庫拖曳至畫布建立節點，點擊節點即可拖移位置。</li>
            <li>拖曳輸出點到另一節點輸入點建立流程順序，點擊線條可刪除。</li>
            <li>提交時系統會依連線自動推算執行順序，若無連線則依建立順序執行。</li>
          </ul>
          <div class="alert alert-info mb-0">每個節點都含有原先的步驟設定欄位，既有流程會自動帶入並串接。</div>
        </div>
      </div>

      <div class="canvas-controls d-flex flex-column align-items-end gap-2">
        <div class="btn-group" role="group" aria-label="Zoom controls">
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="zoomOut()">－</button>
          <div class="btn btn-light btn-sm zoom-indicator" id="zoom-label">100%</div>
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="zoomIn()">＋</button>
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="resetZoom()">重設</button>
        </div>
        <div class="btn-group" role="group" aria-label="Canvas actions">
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="exportFlow()">匯出 JSON</button>
          <button class="btn btn-outline-success btn-sm" type="button" onclick="simulateFlow()">模擬執行</button>
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearCanvas()">清空畫布</button>
        </div>
      </div>

      <div id="flow-canvas" class="p-2">
        <div id="canvas-content">
          <svg id="connections-layer"></svg>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1 align-items-start">
  <div class="col-12">
      <div class="card shadow-sm flow-manage-card">
        <div class="card-header bg-white fw-bold">流程配置與已保存的流程</div>
        <div class="card-body">
          <div class="row g-4 align-items-stretch">
            <div class="col-12 col-xl-5">
              <div class="section-wrap divider-xl">
                <form id="flow_form" action="{{ url_for('run_flow', task_id=task.id) }}" method="post" class="h-100">
                  <input type="hidden" name="ordered_ids" id="ordered_ids" value="">
                  <div class="vstack gap-3 h-100">
                    <div>
                      <label class="form-label">流程名稱</label>
                      <input class="form-control" name="flow_name" value="{{ loaded_name or '' }}">
                      <div class="form-text">保存或執行前請先命名流程。</div>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="center_titles" name="center_titles" {% if center_titles %}checked{% endif %}>
                      <label class="form-check-label" for="center_titles">置中 Table/Figure 標題段落</label>
                    </div>
                    <div>
                      <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="modal" data-bs-target="#filesModal">檔案結構</button>
                    </div>
                    <div class="d-flex gap-2 mt-auto">
                      <button class="btn btn-success flex-fill" type="submit" name="action" value="run">執行流程</button>
                      <button class="btn btn-primary flex-fill" type="submit" name="action" value="save">保存流程</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-12 col-xl-7">
              <div class="section-wrap saved-flows-section">
                <div class="table-responsive">
                  <table class="table table-striped text-center align-middle mb-3">
                    <thead>
                      <tr>
                        <th class="text-center">名稱</th>
                        <th class="text-center">建立時間</th>
                        <th class="text-center">文件格式</th>
                        <th class="text-center">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                    {% for f in flows %}
                      <tr>
                        <td class="align-middle">{{ f.name }}</td>
                        <td class="align-middle">{{ f.created }}</td>
                        <td class="align-middle">
                          <form action="{{ url_for('update_flow_format', task_id=task.id, flow_name=f.name) }}" method="post" class="d-flex flex-column flex-lg-row gap-2 align-items-stretch align-items-lg-center justify-content-center">
                            <select class="form-select form-select-sm" name="document_format">
                              {% for key, meta in format_presets.items() %}
                              <option value="{{ key }}" {% if key == f.document_format %}selected{% endif %}>{{ meta.label }}</option>
                              {% endfor %}
                            </select>
                            <button class="btn btn-sm btn-outline-primary" type="submit">套用</button>
                          </form>
                          <div class="small text-muted mt-1">目前：{{ f.format_label }}</div>
                        </td>
                        <td class="align-middle">
                          <form action="{{ url_for('execute_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" {% if f.has_copy %}onsubmit="return confirm('此流程包含複製檔案步驟，確定要執行嗎？');"{% endif %}>
                            <button class="btn btn-sm btn-outline-success">執行</button>
                          </form>
                          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('flow_builder', task_id=task.id, flow=f.name) }}">編輯</a>
                          <button class="btn btn-sm btn-outline-secondary" type="button" onclick="renameFlow('{{ f.name }}')">重新命名</button>
                          <form action="{{ url_for('delete_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" onsubmit="return confirm('確定刪除?')">
                            <button class="btn btn-sm btn-outline-danger">刪除</button>
                          </form>
                          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_flow', task_id=task.id, flow_name=f.name) }}">匯出</a>
                        </td>
                      </tr>
                    {% else %}
                      <tr><td colspan="4">尚無流程</td></tr>
                    {% endfor %}
                    </tbody>
                  </table>
                </div>
                <form action="{{ url_for('import_flow', task_id=task.id) }}" method="post" enctype="multipart/form-data" class="mt-3">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label">匯入流程 JSON</label>
                      <input class="form-control" type="file" name="flow_file" required>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-primary" type="submit">匯入</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filesModalLabel">檔案結構</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ render_tables(files_tree) }}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="flowModal" tabindex="-1" aria-labelledby="flowModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="flowModalLabel">匯出 / 模擬結果</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="flowModalContent" class="bg-light border rounded p-3" style="max-height: 400px; overflow: auto;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<script>
const TASK_ID = '{{ task.id }}';
const SUPPORTED_STEPS = {{ steps|tojson }};
const AVAILABLE_FILES = {{ files|tojson }};
const PRESET_FLOW = {{ preset|tojson }};

const canvas = document.getElementById('flow-canvas');
const canvasContent = document.getElementById('canvas-content');
const svgLayer = document.getElementById('connections-layer');
const flowForm = document.getElementById('flow_form');
const zoomLabel = document.getElementById('zoom-label');
const componentDrawer = document.querySelector('.component-drawer');
const toggleDrawerBtn = document.getElementById('toggle-drawer');
const hintPanel = document.getElementById('hint-panel');
const toggleHintsBtn = document.getElementById('toggle-hints');
canvas.addEventListener('dragover', allowDrop);
canvas.addEventListener('drop', handleDrop);
canvas.addEventListener('wheel', handleWheelZoom, { passive: false });
canvas.addEventListener('mousedown', startCanvasPan);
let nodes = [];
let connections = [];
let nextNode = 1;
let dragStart = null;
let tempLine = null;
let currentDragNode = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let canvasZoom = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 2;
const ZOOM_STEP = 0.1;
let isPanning = false;
let panState = { x: 0, y: 0, left: 0, top: 0 };

function allowDrop(ev){ ev.preventDefault(); }

function startDragComponent(ev){
  const item = ev.currentTarget?.closest('.component-item') || ev.target.closest('.component-item');
  if (!item) return;
  ev.dataTransfer.setData('type', item.dataset.type);
  ev.dataTransfer.setData('label', item.dataset.label);
}

function applyZoom(){
  canvasContent.style.transform = `scale(${canvasZoom})`;
  if (zoomLabel){
    zoomLabel.textContent = `${Math.round(canvasZoom * 100)}%`;
  }
  updateConnections();
}

function handleWheelZoom(ev){
  if (!ev.ctrlKey) return;
  ev.preventDefault();
  const delta = Math.sign(ev.deltaY || 0);
  if (delta < 0){
    zoomIn();
  } else if (delta > 0){
    zoomOut();
  }
}

function toggleComponentDrawer(){
  if (!componentDrawer || !toggleDrawerBtn) return;
  const collapsed = componentDrawer.classList.toggle('collapsed');
  toggleDrawerBtn.textContent = collapsed ? '顯示元件庫' : '隱藏元件庫';
}

function toggleHintPanel(){
  if (!hintPanel || !toggleHintsBtn) return;
  const hidden = hintPanel.classList.toggle('d-none');
  toggleHintsBtn.textContent = hidden ? '顯示操作提示' : '隱藏操作提示';
}

function startCanvasPan(e){
  if (e.button !== 0) return;
  if (e.target.closest('.flow-node') || e.target.closest('.port') || e.target.closest('.component-drawer') || e.target.closest('.canvas-controls') || e.target.closest('.connection-line')){
    return;
  }
  isPanning = true;
  canvas.classList.add('panning');
  panState = {
    x: e.clientX,
    y: e.clientY,
    left: canvas.scrollLeft,
    top: canvas.scrollTop
  };
  document.addEventListener('mousemove', panCanvas);
  document.addEventListener('mouseup', stopCanvasPan);
}

function panCanvas(e){
  if (!isPanning) return;
  canvas.scrollLeft = panState.left - (e.clientX - panState.x);
  canvas.scrollTop = panState.top - (e.clientY - panState.y);
}

function stopCanvasPan(){
  if (!isPanning) return;
  isPanning = false;
  canvas.classList.remove('panning');
  document.removeEventListener('mousemove', panCanvas);
  document.removeEventListener('mouseup', stopCanvasPan);
}

function zoomIn(){
  canvasZoom = Math.min(MAX_ZOOM, Math.round((canvasZoom + ZOOM_STEP) * 100) / 100);
  applyZoom();
}

function zoomOut(){
  canvasZoom = Math.max(MIN_ZOOM, Math.round((canvasZoom - ZOOM_STEP) * 100) / 100);
  applyZoom();
}

function resetZoom(){
  canvasZoom = 1;
  applyZoom();
}

applyZoom();

function handleDrop(ev){
  ev.preventDefault();
  const type = ev.dataTransfer.getData('type');
  const label = ev.dataTransfer.getData('label');
  if (!type) return;
  const rect = canvas.getBoundingClientRect();
  const x = (ev.clientX - rect.left + canvas.scrollLeft) / canvasZoom;
  const y = (ev.clientY - rect.top + canvas.scrollTop) / canvasZoom;
  createNode(type, label, x, y);
}

function genSid(){
  return `n${Date.now().toString(36)}${Math.random().toString(36).slice(2,5)}`;
}

function renderFields(spec, sid, preset={}){
  let body = '';
  for (const k of spec.inputs){
    const accept = spec.accepts[k];
    let label = k;
    if (k === 'pdf_zip') label = 'PDF ZIP 壓縮檔';
    if (k === 'target_section') label = '章節編號（例如 6.12.1）';
    if (k === 'target_chapter_section') label = '章節編號（例如 6.12.1）';
    if (k === 'target_title_section') label = '章節標題（完整比對）';
    if (k === 'input_file') label = '輸入檔案';
    if (k === 'target_title') label = '擷取標題內容';
    if (k === 'text') label = '輸入文字';
    if (k === 'align') label = '對齊方式';
    if (k === 'bold') label = '粗體';
    if (k === 'source_dir') label = '來源資料夾';
    if (k === 'dest_dir') label = '目的資料夾';
    if (k === 'keywords') label = '關鍵字（逗號分隔）';
    const rawVal = preset[k];
    const val = (rawVal === undefined || rawVal === null) ? '' : String(rawVal);
    if (accept === 'text'){
      body += `<div class="mb-2"><label class="form-label small mb-1">${label}</label>`+
              `<input class="form-control form-control-sm" name="step_${sid}_${k}" value="${val}" placeholder="${label}"></div>`;
    } else if (accept === 'bool'){
      body += `<div class="mb-2"><label class="form-label small mb-1">${label}</label>`+
              `<select class="form-select form-select-sm" name="step_${sid}_${k}">`+
              `<option value="false" ${val==="false"?"selected": ""}>否</option>`+
              `<option value="true" ${val==="true"?"selected": ""}>是</option>`+
              `</select></div>`;
    } else if (accept === 'int' || accept === 'float'){
      if (k === 'level'){
        let options = '', help = '';
        if (spec.label.includes('阿拉伯')){
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（1.）</option>`+
                   `<option value="1" ${val==="1"?"selected": ""}>Level 1（1.1.）</option>`+
                   `<option value="2" ${val==="2"?"selected": ""}>Level 2（1.1.1.）</option>`;
          help = '建議僅用到 Level 2；更深層需先擴充樣式。';
        } else {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（I.）</option>`;
          help = '僅定義 Level 0；要 I→A→1 多層需擴充樣式。';
        }
        body += `<div class="mb-2"><label class="form-label small mb-1">level</label>`+
                `<select class="form-select form-select-sm" name="step_${sid}_${k}">${options}</select>`+
                `<div class="form-text">${help}</div></div>`;
      } else if (k === 'font_size'){
        body += `<div class="mb-2"><label class="form-label small mb-1">字體大小</label>`+
                `<select class="form-select form-select-sm" name="step_${sid}_${k}">`+
                `<option value="12" ${val==="12"?"selected": ""}>12</option>`+
                `<option value="13" ${val==="13"?"selected": ""}>13</option>`+
                `<option value="14" ${val==="14"?"selected": ""}>14</option>`+
                `<option value="16" ${val==="16"?"selected": ""}>16</option>`+
                `<option value="18" ${val==="18"?"selected": ""}>18</option>`+
                `</select></div>`;
      } else if (k === 'before_space' || k === 'after_space'){
        const nice = k === 'before_space' ? '段前間距' : '段後間距';
        body += `<div class="mb-2"><label class="form-label small mb-1">${nice}</label>`+
                `<select class="form-select form-select-sm" name="step_${sid}_${k}">`+
                `<option value="0" ${val==="0"?"selected": ""}>0 pt</option>`+
                `<option value="6" ${val==="6"?"selected": ""}>6 pt</option>`+
                `<option value="12" ${val==="12"?"selected": ""}>12 pt</option>`+
                `</select></div>`;
      } else {
        body += `<div class="mb-2"><label class="form-label small mb-1">${label}</label>`+
                `<input class="form-control form-control-sm" type="number" step="any" name="step_${sid}_${k}" value="${val}" placeholder="${label}"></div>`;
      }
    } else if (accept.startsWith('file')){
      const ext = accept.split(':')[1];
      const options = (AVAILABLE_FILES[ext] || []).map(f => `<option value="${f}" ${val===f?"selected": ""}>${f}</option>`).join('');
      const placeholder = ext === 'dir' ? '選擇資料夾' : '選擇檔案';
      const selected = val ? '' : 'selected';
      body += `<div class="mb-2"><label class="form-label small mb-1">${label}</label>`+
              `<select class="form-select form-select-sm" name="step_${sid}_${k}" required>`+
              `<option value="" disabled ${selected}>${placeholder}</option>${options}`+
              `</select></div>`;
    } else if (k === 'align'){
      body += `<div class="mb-2"><label class="form-label small mb-1">對齊</label>`+
              `<select class="form-select form-select-sm" name="step_${sid}_align">`+
              `<option value="left" ${val==="left"?"selected": ""}>靠左</option>`+
              `<option value="center" ${val==="center"?"selected": ""}>置中</option>`+
              `<option value="right" ${val==="right"?"selected": ""}>靠右</option>`+
              `<option value="justify" ${val==="justify"?"selected": ""}>左右對齊</option>`+
              `</select>`+
              `<div class="form-text">一般內文建議使用 左/左右對齊；標題多用 置中。</div></div>`;
    }
  }
  return body;
}

function createNode(type, label, x=60, y=60, preset={}){
  const sid = genSid();
  const spec = SUPPORTED_STEPS[type];
  if (!spec){
    alert(`未知的元件類型：${type}`);
    return null;
  }
  const node = document.createElement('div');
  node.className = 'flow-node card';
  node.dataset.sid = sid;
  node.style.left = `${x}px`;
  node.style.top = `${y}px`;

  node.innerHTML = `
    <div class="card-header py-2 d-flex justify-content-between align-items-center" onmousedown="startDragNode(event, '${sid}')">
      <div class="fw-semibold small">${label}</div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-light text-secondary border">雙擊設定</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeNode('${sid}')">刪除</button>
      </div>
    </div>
    <div class="card-body p-2 node-settings d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted small">設定</div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeNodeSettings('${sid}')">收合</button>
      </div>
      <input type="hidden" name="step_${sid}_type" value="${type}">
      ${renderFields(spec, sid, preset)}
    </div>`;

  const inputPort = document.createElement('div');
  inputPort.className = 'port input';
  inputPort.onmouseup = (e) => endConnection(e, sid);
  node.appendChild(inputPort);

  const outputPort = document.createElement('div');
  outputPort.className = 'port output';
  outputPort.onmousedown = (e) => startConnection(e, sid);
  node.appendChild(outputPort);

  node.ondblclick = (e) => {
    e.stopPropagation();
    openNodeSettings(sid);
  };

  canvasContent.appendChild(node);
  nodes.push({ id: sid, type, label, el: node, index: nextNode++ });
  return sid;
}

function openNodeSettings(sid){
  const node = nodes.find(n => n.id === sid);
  if (!node) return;
  const body = node.el.querySelector('.node-settings');
  if (body){
    body.classList.remove('d-none');
  }
}

function closeNodeSettings(sid){
  const node = nodes.find(n => n.id === sid);
  if (!node) return;
  const body = node.el.querySelector('.node-settings');
  if (body){
    body.classList.add('d-none');
  }
}

function removeNode(sid){
  const node = nodes.find(n => n.id === sid);
  if (node){
    node.el.remove();
    nodes = nodes.filter(n => n.id !== sid);
    connections = connections.filter(c => c.from !== sid && c.to !== sid);
    updateConnections();
  }
}

function startDragNode(e, sid){
  if (e.detail === 2){
    return;
  }
  e.stopPropagation();
  currentDragNode = sid;
  const node = nodes.find(n => n.id === sid);
  const canvasRect = canvas.getBoundingClientRect();
  const rect = node.el.getBoundingClientRect();
  dragOffsetX = ((e.clientX - canvasRect.left) + canvas.scrollLeft) / canvasZoom - parseFloat(node.el.style.left);
  dragOffsetY = ((e.clientY - canvasRect.top) + canvas.scrollTop) / canvasZoom - parseFloat(node.el.style.top);
  document.addEventListener('mousemove', moveNode);
  document.addEventListener('mouseup', stopDragNode);
}

function moveNode(e){
  if (!currentDragNode) return;
  const node = nodes.find(n => n.id === currentDragNode);
  const canvasRect = canvas.getBoundingClientRect();
  const x = ((e.clientX - canvasRect.left) + canvas.scrollLeft) / canvasZoom - dragOffsetX;
  const y = ((e.clientY - canvasRect.top) + canvas.scrollTop) / canvasZoom - dragOffsetY;
  node.el.style.left = `${x}px`;
  node.el.style.top = `${y}px`;
  updateConnections();
}

function stopDragNode(){
  currentDragNode = null;
  document.removeEventListener('mousemove', moveNode);
  document.removeEventListener('mouseup', stopDragNode);
}

function startConnection(e, sid){
  e.stopPropagation();
  const rect = e.target.getBoundingClientRect();
  const canvasRect = canvas.getBoundingClientRect();
  dragStart = {
    nodeId: sid,
    x: (rect.left + rect.width / 2 - canvasRect.left + canvas.scrollLeft) / canvasZoom,
    y: (rect.top + rect.height / 2 - canvasRect.top + canvas.scrollTop) / canvasZoom,
    el: e.target
  };
  tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  tempLine.setAttribute('class', 'connection-line');
  tempLine.setAttribute('stroke-dasharray', '5,5');
  svgLayer.appendChild(tempLine);
  document.addEventListener('mousemove', drawTempLine);
  document.addEventListener('mouseup', abortConnection);
}

function drawTempLine(e){
  if (!dragStart) return;
  const canvasRect = canvas.getBoundingClientRect();
  const endX = (e.clientX - canvasRect.left + canvas.scrollLeft) / canvasZoom;
  const endY = (e.clientY - canvasRect.top + canvas.scrollTop) / canvasZoom;
  const d = getBezierPath(dragStart.x, dragStart.y, endX, endY);
  tempLine.setAttribute('d', d);
}

function endConnection(e, targetId){
  if (!dragStart) return;
  e.stopPropagation();
  if (dragStart.nodeId === targetId){
    cleanTempLine();
    return;
  }
  // 移除既有指向目標的連線，以保持單一輸入
  connections = connections.filter(c => c.to !== targetId);
  const exists = connections.find(c => c.from === dragStart.nodeId && c.to === targetId);
  if (!exists){
    connections.push({
      id: `c-${Date.now()}`,
      from: dragStart.nodeId,
      to: targetId,
      fromPortEl: dragStart.el,
      toPortEl: e.target
    });
  }
  updateConnections();
  cleanTempLine();
}

function abortConnection(){ cleanTempLine(); }

function cleanTempLine(){
  dragStart = null;
  if (tempLine){ tempLine.remove(); tempLine = null; }
  document.removeEventListener('mousemove', drawTempLine);
  document.removeEventListener('mouseup', abortConnection);
}

function getBezierPath(x1, y1, x2, y2){
  const curvature = 0.5;
  const hx1 = x1 + Math.abs(x2 - x1) * curvature;
  const hx2 = x2 - Math.abs(x2 - x1) * curvature;
  return `M ${x1} ${y1} C ${hx1} ${y1} ${hx2} ${y2} ${x2} ${y2}`;
}

function updateConnections(){
  const lines = Array.from(svgLayer.querySelectorAll('.connection-line:not([stroke-dasharray])'));
  lines.forEach(l => l.remove());
  const canvasRect = canvas.getBoundingClientRect();
  connections.forEach(conn => {
    const fromRect = conn.fromPortEl.getBoundingClientRect();
    const toRect = conn.toPortEl.getBoundingClientRect();
    const x1 = (fromRect.left + fromRect.width / 2 - canvasRect.left + canvas.scrollLeft) / canvasZoom;
    const y1 = (fromRect.top + fromRect.height / 2 - canvasRect.top + canvas.scrollTop) / canvasZoom;
    const x2 = (toRect.left + toRect.width / 2 - canvasRect.left + canvas.scrollLeft) / canvasZoom;
    const y2 = (toRect.top + toRect.height / 2 - canvasRect.top + canvas.scrollTop) / canvasZoom;
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'connection-line');
    path.setAttribute('d', getBezierPath(x1, y1, x2, y2));
    path.onclick = (evt) => {
      evt.stopPropagation();
      if (confirm('刪除這條連線？')){
        connections = connections.filter(c => c.id !== conn.id);
        updateConnections();
      }
    };
    svgLayer.appendChild(path);
  });
}

function clearCanvas(){
  nodes.forEach(n => n.el.remove());
  nodes = [];
  connections = [];
  nextNode = 1;
  updateConnections();
}

function computeOrder(){
  const indegree = {};
  const adj = {};
  nodes.forEach(n => { indegree[n.id] = 0; adj[n.id] = []; });
  connections.forEach(c => { indegree[c.to] = (indegree[c.to] || 0) + 1; adj[c.from].push(c.to); });
  const queue = nodes.filter(n => indegree[n.id] === 0).slice().sort((a,b)=>a.index-b.index);
  const order = [];
  while(queue.length){
    const n = queue.shift();
    order.push(n.id);
    for (const to of adj[n.id]){
      indegree[to] -= 1;
      if (indegree[to] === 0){
        const target = nodes.find(nn => nn.id === to);
        queue.push(target);
      }
    }
    queue.sort((a,b)=>a.index-b.index);
  }
  if (order.length !== nodes.length){
    // 有循環時，以建立順序補齊
    nodes.slice().sort((a,b)=>a.index-b.index).forEach(n => { if(!order.includes(n.id)) order.push(n.id); });
  }
  return order;
}

function exportFlow(){
  const payload = {
    nodes: nodes.map(n => ({ id: n.id, type: n.type, label: n.label })),
    connections: connections.map(c => ({ from: c.from, to: c.to })),
    order: computeOrder()
  };
  showModal(JSON.stringify(payload, null, 2));
}

function simulateFlow(){
  const order = computeOrder();
  if (!order.length){
    showModal('尚未建立節點');
    return;
  }
  let log = '模擬執行日誌\n-----------------\n';
  order.forEach((sid, idx) => {
    const node = nodes.find(n => n.id === sid);
    log += `[${idx+1}] ${node.label} (${sid})\n`;
  });
  showModal(log);
}

function showModal(content){
  const modalBody = document.getElementById('flowModalContent');
  modalBody.textContent = content;
  const modal = new bootstrap.Modal(document.getElementById('flowModal'));
  modal.show();
}

function renameFlow(current){
  const name = prompt('輸入新流程名稱', current);
  if(!name) return;
  const form = document.createElement('form');
  form.method = 'post';
  form.action = `/tasks/${TASK_ID}/flows/rename/${current}`;
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'name';
  input.value = name;
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

function prepareSubmission(action){
  if ((action === 'save' || action === 'run') && !flowForm.elements['flow_name'].value.trim()){
    alert('請輸入流程名稱');
    return false;
  }
  const order = computeOrder();
  if (!order.length){
    alert('請至少建立一個節點');
    return false;
  }
  document.getElementById('ordered_ids').value = order.join(',');
  return true;
}

flowForm.addEventListener('submit', (e) => {
  const action = e.submitter?.value;
  const ok = prepareSubmission(action);
  if (!ok){
    e.preventDefault();
  }
});

function initFromPreset(){
  if (!Array.isArray(PRESET_FLOW)) return;
  let y = 40;
  let prev = null;
  PRESET_FLOW.forEach(st => {
    const sid = createNode(st.type, SUPPORTED_STEPS[st.type]?.label || st.type, 320, y, st.params || {});
    if (!sid) return;
    if (prev){
      const fromNode = nodes.find(n => n.id === prev);
      const toNode = nodes.find(n => n.id === sid);
      if (fromNode && toNode){
        const fromPort = fromNode.el.querySelector('.port.output');
        const toPort = toNode.el.querySelector('.port.input');
        connections.push({
          id: `c-${Date.now()}-${sid}`,
          from: prev,
          to: sid,
          fromPortEl: fromPort,
          toPortEl: toPort
        });
      }
    }
    prev = sid;
    y += 180;
  });
  updateConnections();
}

initFromPreset();
</script>
{% endblock %}

