{% extends "base.html" %}
{% block content %}
{% macro render_tables(node, path="") %}
  {% if node.files %}
  <h3 class="h6 mt-3">{{ path or '根目錄' }}</h3>
  <table class="table table-sm">
    <tbody>
      {% for fname in node.files %}
      <tr><td>{{ fname }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% for dname, dnode in node.dirs.items() %}
    {{ render_tables(dnode, path ~ ("/" if path else "") ~ dname) }}
  {% endfor %}
{% endmacro %}
<h1 class="h3 mb-3">定義流程</h1>

<form id="flow_form" action="{{ url_for('run_flow', task_id=task.id) }}" method="post" class="vstack gap-3">
  <input type="hidden" name="ordered_ids" id="ordered_ids" value="">
  <input type="hidden" name="existing_steps" id="existing_steps_field" value="">
  {% if format_only and loaded_name %}
  <div class="alert alert-info">流程步驟維持不變，僅提供調整「{{ loaded_name }}」的文件格式。</div>
  {% endif %}
  <div id="steps" class="vstack gap-3{% if format_only %} d-none{% endif %}"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">流程名稱</label>
      <input class="form-control" name="flow_name" value="{{ loaded_name or '' }}">
    </div>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="center_titles" name="center_titles" {% if center_titles %}checked{% endif %}>
    <label class="form-check-label" for="center_titles">置中 Table/Figure 標題段落</label>
  </div>

  <div class="d-flex gap-2 mt-2">
    {% if not format_only %}
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">新增步驟</button>
      <ul class="dropdown-menu">
        {% for key, meta in steps.items() %}
        <li><a class="dropdown-item" href="#" onclick="addStep('{{ key|e }}'); return false;">{{ meta.label }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
      <button class="btn btn-success" type="submit" name="action" value="run">執行流程</button>
      <button class="btn btn-secondary" type="submit" name="action" value="save">保存流程</button>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#formatSettings" aria-expanded="{{ 'true' if formatting_open else 'false' }}" aria-controls="formatSettings">調整文件格式</button>
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#filesModal">檔案結構</button>
    </div>
  <div class="collapse mt-3 {% if formatting_open %}show{% endif %}" id="formatSettings">
    <div class="card">
      <div class="card-body">
        <h2 class="h5">文件格式設置</h2>
        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <label class="form-label">西文字體</label>
            <input class="form-control" name="format_western_font" value="{{ formatting.western_font }}" placeholder="Times New Roman">
          </div>
          <div class="col-md-4">
            <label class="form-label">中文/東亞字體</label>
            <input class="form-control" name="format_east_asian_font" value="{{ formatting.east_asian_font }}" placeholder="新細明體">
          </div>
          <div class="col-md-4">
            <label class="form-label">字體大小</label>
            <select class="form-select" name="format_font_size">
              {% for size in [10, 11, 12, 13, 14, 16, 18] %}
              <option value="{{ size }}" {% if formatting.font_size == size %}selected{% endif %}>{{ size }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">行距</label>
            <select class="form-select" name="format_line_spacing">
              {% for spacing in [1, 1.15, 1.5, 2] %}
              <option value="{{ spacing }}" {% if formatting.line_spacing == spacing %}selected{% endif %}>{{ spacing }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">段前間距</label>
            <select class="form-select" name="format_space_before">
              {% for space in [0, 3, 6, 12] %}
              <option value="{{ space }}" {% if formatting.space_before == space %}selected{% endif %}>{{ space }} pt</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">段後間距</label>
            <select class="form-select" name="format_space_after">
              {% for space in [0, 3, 6, 12] %}
              <option value="{{ space }}" {% if formatting.space_after == space %}selected{% endif %}>{{ space }} pt</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-text mt-2">上述設定將套用至整份輸出文件，保存流程時會一併記錄。</div>
      </div>
    </div>
  </div>
  </form>

<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filesModalLabel">檔案結構</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ render_tables(files_tree) }}
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
</div>
<hr>
<h2 class="h5 mt-4">已保存的流程</h2>
<table class="table table-striped text-center">
  <thead>
    <tr>
      <th class="text-center">名稱</th>
      <th class="text-center">建立時間</th>
      <th class="text-center">操作</th>
    </tr>
  </thead>
  <tbody>
  {% for f in flows %}
    <tr>
      <td>{{ f.name }}</td>
      <td>{{ f.created }}</td>
      <td>
        <form action="{{ url_for('execute_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" {% if f.has_copy %}onsubmit="return confirm('此流程包含複製檔案步驟，確定要執行嗎？');"{% endif %}>
          <button class="btn btn-sm btn-outline-success">執行</button>
        </form>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('flow_builder', task_id=task.id, flow=f.name) }}">編輯</a>
        <a class="btn btn-sm btn-outline-info" href="{{ url_for('flow_builder', task_id=task.id, flow=f.name, show_format='1', format_only='1') }}" title="調整輸出文件的字型、行距等設定">調整格式</a>
        {% if f.custom_format %}<span class="badge text-bg-info ms-1 align-middle">已自訂</span>{% endif %}
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="renameFlow('{{ f.name }}')">重新命名</button>
        <form action="{{ url_for('delete_flow', task_id=task.id, flow_name=f.name) }}" method="post" class="d-inline" onsubmit="return confirm('確定刪除?')">
          <button class="btn btn-sm btn-outline-danger">刪除</button>
        </form>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('export_flow', task_id=task.id, flow_name=f.name) }}">匯出</a>
        </td>
      </tr>
    {% else %}
    <tr><td colspan="3">尚無流程</td></tr>
  {% endfor %}
  </tbody>
</table>

<form action="{{ url_for('import_flow', task_id=task.id) }}" method="post" enctype="multipart/form-data" class="mt-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-6">
      <label class="form-label">匯入流程 JSON</label>
      <input class="form-control" type="file" name="flow_file" required>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-primary" type="submit">匯入</button>
    </div>
  </div>
</form>

<script>
const TASK_ID = '{{ task.id }}';
const SUPPORTED_STEPS = {{ steps|tojson }};
const AVAILABLE_FILES = {{ files|tojson }};
const PRESET_FLOW = {{ preset|tojson }};
const EXISTING_STEPS = {{ existing_steps|tojson }};
const IS_FORMAT_ONLY = {{ format_only|tojson }};
let isInitialising = true;
let isDirty = false;
function markDirty(){
  if (!isInitialising) isDirty = true;
}
window.addEventListener('beforeunload', function(e){
  if (!isDirty) return;
  e.preventDefault();
  e.returnValue = '';
});
const flowForm = document.getElementById('flow_form');
const existingStepsField = document.getElementById('existing_steps_field');
if (existingStepsField){
  const initial = Array.isArray(EXISTING_STEPS) ? EXISTING_STEPS : [];
  existingStepsField.value = JSON.stringify(initial);
  if (IS_FORMAT_ONLY && initial.length){
    existingStepsField.dataset.keep = '1';
  } else {
    existingStepsField.dataset.keep = '0';
  }
}

flowForm.addEventListener('submit', (e) => {
  const action = e.submitter?.value;
  if ((action === 'save' || action === 'run') && !flowForm.elements['flow_name'].value.trim()) {
    e.preventDefault();
    alert('請輸入流程名稱');
    return;
  }
  if (action === 'run') {
    const hasCopy = Array.from(flowForm.querySelectorAll('input[name$="_type"]'))
      .some(el => el.value === 'copy_files');
    if (hasCopy && !confirm('此流程包含複製檔案步驟，確定要執行嗎？')) {
      e.preventDefault();
      return;
    }
  }
  syncExistingStepsField();
  isDirty = false;
});
flowForm.addEventListener('input', () => { markDirty(); syncExistingStepsField(); });
flowForm.addEventListener('change', () => { markDirty(); syncExistingStepsField(); });
function captureCurrentSteps(){
  const steps = [];
  document.querySelectorAll('#steps .card').forEach(card => {
    const sid = card.dataset.sid;
    if (!sid) return;
    const typeField = flowForm.elements[`step_${sid}_type`];
    const stype = typeField?.value;
    if (!stype || !SUPPORTED_STEPS[stype]) return;
    const params = {};
    for (const key of SUPPORTED_STEPS[stype].inputs){
      const field = flowForm.elements[`step_${sid}_${key}`];
      if (!field) continue;
      params[key] = field.value ?? '';
    }
    steps.push({ type: stype, params });
  });
  return steps;
}
function syncExistingStepsField(){
  if (!existingStepsField) return;
  const cards = document.querySelectorAll('#steps .card');
  if (!cards.length){
    if (existingStepsField.dataset.keep === '1'){
      return;
    }
    existingStepsField.value = '[]';
    return;
  }
  existingStepsField.dataset.keep = '0';
  existingStepsField.value = JSON.stringify(captureCurrentSteps());
}
function genId(){ return (Date.now().toString(36) + Math.random().toString(36).slice(2,7)); }
function updateOrder(){
  const ids = Array.from(document.querySelectorAll("#steps .card")).map(el => el.dataset.sid);
  document.getElementById("ordered_ids").value = ids.join(",");
  markDirty();
  syncExistingStepsField();
}
function addStep(typeKey, preset={}, refSid=null, position='end'){
  const spec = SUPPORTED_STEPS[typeKey];
  const sid = genId();
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.sid = sid;

  let menuBefore = '', menuAfter = '';
  for (const [k, m] of Object.entries(SUPPORTED_STEPS)){
    menuBefore += `<li><a class="dropdown-item" href="#" onclick="addStep('${k}', {}, '${sid}', 'before'); return false;">${m.label}</a></li>`;
    menuAfter  += `<li><a class="dropdown-item" href="#" onclick="addStep('${k}', {}, '${sid}', 'after'); return false;">${m.label}</a></li>`;
  }

  let body = `<div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">${spec.label}</h2>
      <div class="btn-group">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入上方</button>
          <ul class="dropdown-menu">${menuBefore}</ul>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">插入下方</button>
          <ul class="dropdown-menu">${menuAfter}</ul>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp('${sid}')">上移</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown('${sid}')">下移</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${sid}')">刪除</button>
      </div>
    </div>
    <input type="hidden" name="step_${sid}_type" value="${typeKey}">
    <div class="row g-3 mt-1">`;

  for (const k of spec.inputs){
    const accept = spec.accepts[k];
    let label = k;
    if (k === "pdf_zip") label = "PDF ZIP 壓縮檔";
    if (k === "target_section") label = "章節編號（例如 6.12.1）";
    if (k === "target_chapter_section") label = "章節編號（例如 6.12.1）";
    if (k === "target_title_section") label = "章節標題（完整比對）";
    if (k === "input_file") label = "輸入檔案";
    if (k === "target_title") label = "擷取標題內容";
    if (k === "text") label = "輸入文字";
    if (k === "align") label = "對齊方式";
    if (k === "bold") label = "粗體";
    if (k === "source_dir") label = "來源資料夾";
    if (k === "dest_dir") label = "目的資料夾";
    if (k === "keywords") label = "關鍵字（逗號分隔）";

    const val = preset[k] || "";
    if (accept === "text"){
      body += `<div class="col-md-6"><label class="form-label">${label}</label>
               <input class="form-control" name="step_${sid}_${k}" value="${val}" placeholder="${label}"></div>`;
    } else if (accept === "bool"){
      body += `<div class="col-md-3"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}">
                 <option value="false" ${val==="false"?"selected": ""}>否</option>
                 <option value="true" ${val==="true"?"selected": ""}>是</option>
               </select>
             </div>`;
    } else if (accept === "int" || accept === "float"){
      if (k === "level") {
        let options = "", help = "";
        if (typeKey === "insert_numbered_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（1.）</option>
                     <option value="1" ${val==="1"?"selected": ""}>Level 1（1.1.）</option>
                     <option value="2" ${val==="2"?"selected": ""}>Level 2（1.1.1.）</option>`;
          help = "建議僅用到 Level 2；更深層需先擴充樣式。";
        } else if (typeKey === "insert_roman_heading") {
          options = `<option value="0" ${val==="0"?"selected": ""}>Level 0（I.）</option>`;
          help = "僅定義 Level 0；要 I→A→1 多層需擴充樣式。";
        } else {
          options = `<option value="0" ${val==="0"?"selected": ""}>0</option>`;
        }
        body += `<div class="col-md-4">
                   <label class="form-label">level</label>
                   <select class="form-select" name="step_${sid}_${k}">${options}</select>
                   <div class="form-text">${help}</div>
                 </div>`;
      } else if (k === "font_size") {
        body += `<div class="col-md-3"><label class="form-label">字體大小</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="12" ${val==="12"?"selected": ""}>12</option>
                   <option value="13" ${val==="13"?"selected": ""}>13</option>
                   <option value="14" ${val==="14"?"selected": ""}>14</option>
                   <option value="16" ${val==="16"?"selected": ""}>16</option>
                   <option value="18" ${val==="18"?"selected": ""}>18</option>
                 </select></div>`;
      } else if (k === "before_space" || k === "after_space") {
        const nice = k === "before_space" ? "段前間距" : "段後間距";
        body += `<div class="col-md-3"><label class="form-label">${nice}</label>
                 <select class="form-select" name="step_${sid}_${k}">
                   <option value="0" ${val==="0"?"selected": ""}>0 pt</option>
                   <option value="6" ${val==="6"?"selected": ""}>6 pt</option>
                   <option value="12" ${val==="12"?"selected": ""}>12 pt</option>
                 </select></div>`;
      } else {
        body += `<div class="col-md-3"><label class="form-label">${label}</label>
                 <input class="form-control" type="number" step="any" name="step_${sid}_${k}" value="${val}" placeholder="${label}"></div>`;
      }
    } else if (accept.startsWith("file")){
      const ext = accept.split(":")[1];
      const options = (AVAILABLE_FILES[ext] || []).map(f => `<option value="${f}" ${val===f?"selected": ""}>${f}</option>`).join("");
      const placeholder = ext === "dir" ? "選擇資料夾" : "選擇檔案";
      const selected = val ? "" : "selected";
      body += `<div class="col-md-6"><label class="form-label">${label}</label>
               <select class="form-select" name="step_${sid}_${k}" required>
                 <option value="" disabled ${selected}>${placeholder}</option>${options}
               </select></div>`;
    } else if (k === "align"){
      body += `<div class="col-md-3"><label class="form-label">對齊</label>
               <select class="form-select" name="step_${sid}_align">
                 <option value="left" ${val==="left"?"selected": ""}>靠左</option>
                 <option value="center" ${val==="center"?"selected": ""}>置中</option>
                 <option value="right" ${val==="right"?"selected": ""}>靠右</option>
                 <option value="justify" ${val==="justify"?"selected": ""}>左右對齊</option>
               </select>
               <div class="form-text">一般內文建議使用 左/左右對齊；標題多用 置中。</div>
             </div>`;
    }
  }

  body += `</div></div>`;
  card.innerHTML = body;
  const container = document.getElementById("steps");
  if (refSid){
    const ref = document.querySelector(`.card[data-sid="${refSid}"]`);
    if (ref){
      if (position === 'before'){
        container.insertBefore(card, ref);
      } else {
        container.insertBefore(card, ref.nextSibling);
      }
    } else {
      container.appendChild(card);
    }
  } else {
    container.appendChild(card);
  }
  updateOrder();
}
function removeStep(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (el) el.remove();
  updateOrder();
}
function moveUp(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (!el) return;
  const prev = el.previousElementSibling;
  if (prev) el.parentNode.insertBefore(el, prev);
  updateOrder();
}
function moveDown(sid){
  const el = document.querySelector(`.card[data-sid="${sid}"]`);
  if (!el) return;
  const next = el.nextElementSibling;
  if (next) el.parentNode.insertBefore(next, el);
  updateOrder();
}
function renameFlow(current){
  const name = prompt('輸入新流程名稱', current);
  if(!name) return;
  const form = document.createElement('form');
  form.method = 'post';
  form.action = `/tasks/${TASK_ID}/flows/rename/${current}`;
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'name';
  input.value = name;
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}
if (PRESET_FLOW){
  for (const st of PRESET_FLOW){
    addStep(st.type, st.params);
  }
}
isInitialising = false;
</script>
{% endblock %}

