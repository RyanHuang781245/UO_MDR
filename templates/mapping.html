{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">上傳 Mapping Excel</h1>
<form id="mapping_form" action="{{ url_for('run_mapping', task_id=task_id) }}" method="post" enctype="multipart/form-data" class="card card-body">
  <div class="row g-3">
    <div class="col-md-9">
      <input class="form-control" type="file" name="mapping_file" accept=".xlsx" required>
    </div>
    <div class="col-md-3 d-grid">
      <button class="btn btn-primary" type="submit">執行</button>
    </div>
  </div>
</form>
<div id="result" class="mt-4"></div>
<script>
const form = document.getElementById('mapping_form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const res = await fetch(form.action, {method: 'POST', body: fd});
  const resultDiv = document.getElementById('result');
  if (!res.ok) {
    resultDiv.innerHTML = '<div class="alert alert-danger">處理失敗</div>';
    return;
  }
  const data = await res.json();
  let html = `<p class="mb-2">Job ID: <code>${data.job_id}</code></p>`;
  if (data.documents && data.documents.length) {
    html += '<ul>';
    for (const doc of data.documents) {
      const url = `/tasks/{{ task_id }}/view/${data.job_id}/${doc}`;
      html += `<li><a href="${url}">${doc}</a></li>`;
    }
    html += '</ul>';
  } else {
    html += '<div class="alert alert-warning">未產生文件</div>';
  }
  resultDiv.innerHTML = html;
});
</script>
{% endblock %}
